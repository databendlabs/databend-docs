---
title: JSON ä¼˜åŒ–
description: Databend Query çš„ JSON ä¼˜åŒ–
---

- RFC PR: [datafuselabs/databend#6995](https://github.com/databendlabs/databend/pull/6995)
- Tracking Issue: [datafuselabs/databend#6994](https://github.com/databendlabs/databend/issues/6994)

## æ¦‚è¦

æœ¬ RFC æè¿°äº† JSON æ€§èƒ½ä¼˜åŒ–çš„è®¾è®¡ã€‚

## åŠ¨æœº

ç›®å‰ï¼ŒDatabend åŠç»“æž„åŒ–æ•°æ®ä»¥åŽŸå§‹æ–‡æœ¬ JSON æ ¼å¼å­˜å‚¨ï¼Œå¹¶ä½¿ç”¨ `serde_json` è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚
å®ƒå­˜åœ¨ä»¥ä¸‹æ€§èƒ½é—®é¢˜ï¼š

1. æ¯æ¬¡ä½¿ç”¨ JSON éƒ½å¿…é¡»è§£æžï¼Œè€Œæ–‡æœ¬è§£æžéžå¸¸æ…¢ï¼Œç‰¹åˆ«æ˜¯å¯¹äºŽå¤§åž‹å¤æ‚å¯¹è±¡æ•°æ®ã€‚
2. æŸ¥è¯¢å•ä¸ªé”®è·¯å¾„éœ€è¦è¯»å–å’Œè§£æžæ•´ä¸ª JSON æ•°æ®ï¼Œè¿™éœ€è¦æ›´å¤šçš„è§£æžæ—¶é—´å¹¶å ç”¨æ›´å¤šçš„å†…å­˜ã€‚

ä¸ºäº†ä½¿åŠç»“æž„åŒ–æ•°æ®çš„æŸ¥è¯¢æ€§èƒ½ä¸Žå…¶ä»–æ•°æ®ç±»åž‹ä¸€æ ·å¿«ã€‚æœ¬ RFC å¼•å…¥äº†ä»¥ä¸‹ä¸¤ä¸ªææ¡ˆï¼š

- è‡ªåŠ¨æ£€æµ‹ JSON åˆ—ä¸­ç»å¸¸æŸ¥è¯¢çš„é”®è·¯å¾„ï¼Œå¹¶å°†å®ƒä»¬æå–ä¸ºè™šæ‹Ÿåˆ—ï¼Œä»¥å®žçŽ°ä¸Žå…¶ä»–åˆ—ç±»ä¼¼çš„æŸ¥è¯¢æ€§èƒ½ã€‚
- ä½¿ç”¨ JSONB è€Œä¸æ˜¯ JSON ä½œä¸ºåŠç»“æž„åŒ–æ•°æ®ç±»åž‹çš„åº•å±‚äºŒè¿›åˆ¶ç¼–ç æ ¼å¼ï¼Œè¿™å°†ä¼˜åŒ–è§£æžé€Ÿåº¦å¹¶æœ‰åˆ©äºŽé”®è·¯å¾„è®¿é—®ã€‚

## æŒ‡å¯¼æ€§è§£é‡Š

æ— ã€‚

## å‚è€ƒçº§è§£é‡Š

### è™šæ‹Ÿåˆ—

JSON çš„ schema å¯ä»¥ä»»æ„æ›´æ”¹ã€‚ä½†æ˜¯ï¼Œåœ¨å®žé™…ä½¿ç”¨ä¸­ï¼ŒJSON æ•°æ®é€šå¸¸ç”±æœºå™¨ç”Ÿæˆï¼Œå¹¶ä¸”å…·æœ‰ç›¸å½“ä¸¥æ ¼å’Œå¯é¢„æµ‹çš„ç»“æž„ã€‚
åˆ©ç”¨æ­¤ç‰¹æ€§ï¼Œæˆ‘ä»¬å¯ä»¥æ£€æµ‹å¹¶æå– JSON ä¸­ç»å¸¸æŸ¥è¯¢çš„é”®è·¯å¾„ä½œä¸ºè™šæ‹Ÿåˆ—ï¼Œä»¥åŠ é€ŸæŸ¥è¯¢å¤„ç†ã€‚

#### æ”¶é›†ç»å¸¸è®¿é—®çš„ JSON é”®è·¯å¾„

æå–å’Œå­˜å‚¨è™šæ‹Ÿåˆ—éœ€è¦é¢å¤–çš„è§£æžè¿‡ç¨‹å’Œå­˜å‚¨èµ„æºï¼Œå› æ­¤ä¸ºæ‰€æœ‰é”®è·¯å¾„ç”Ÿæˆè™šæ‹Ÿåˆ—æ˜¯ä¸åˆé€‚çš„ã€‚
æˆ‘ä»¬åº”è¯¥åªä¸ºç»å¸¸æŸ¥è¯¢çš„ JSON é”®è·¯å¾„ç”Ÿæˆè™šæ‹Ÿåˆ—ã€‚

ä¸ºäº†çŸ¥é“å“ªäº›é”®è·¯å¾„ç»å¸¸è¢«æŸ¥è¯¢ï¼Œ
æˆ‘ä»¬ä½¿ç”¨ [FPGrowth ç®—æ³•](https://link.springer.com/content/pdf/10.1023/B:DAMI.0000005258.31418.83.pdf) æ¥ç»Ÿè®¡ JSON æ•°æ®é”®è·¯å¾„çš„è®¿é—®é¢‘çŽ‡ã€‚
"FP" ä»£è¡¨é¢‘ç¹æ¨¡å¼ï¼Œé€šå¸¸ç”¨äºŽè®¡ç®—é¡¹ç›®é¢‘çŽ‡å¹¶è¯†åˆ«é¢‘ç¹é¡¹ç›®ã€‚
æ¯æ¬¡ç”¨æˆ·æŸ¥è¯¢ JSON æ•°æ®çš„æŸä¸ªé”®è·¯å¾„æ—¶ï¼ŒFPGrowth ç®—æ³•éƒ½ä¼šè®°å½•å®ƒï¼Œæœ€ç»ˆç”Ÿæˆä¸€ä¸ªæ ‘çŠ¶çš„ç»Ÿè®¡ä¿¡æ¯ã€‚
æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ­¤ç»Ÿè®¡ä¿¡æ¯æ¥ç¡®å®šå“ªäº›é”®è·¯å¾„éœ€è¦ç”Ÿæˆè™šæ‹Ÿåˆ—ã€‚

#### æå–è™šæ‹Ÿåˆ—

æå–è™šæ‹Ÿåˆ—çš„æ“ä½œæ˜¯å¼‚æ­¥æ‰§è¡Œçš„ï¼Œå› æ­¤ä¸ä¼šå½±å“æ•°æ®æ’å…¥çš„æ€§èƒ½ã€‚
ç”±äºŽ Databend ä¼šå®šæœŸåŽ‹ç¼©è¡¨å—ï¼Œæˆ‘ä»¬å¯ä»¥å°†æå–è™šæ‹Ÿåˆ—ä½œä¸ºé™„åŠ æ“ä½œï¼Œå¦‚æžœåˆ—æ•°æ®ç±»åž‹ä¸º JSONã€‚
è¿™æ ·ï¼Œå¯ä»¥é‡ç”¨å·²è¯»å–ç”¨äºŽåŽ‹ç¼©çš„æ•°æ®ï¼Œè¿™å°†å‡å°‘ä¸å¿…è¦çš„è¯»å–æ”¾å¤§ã€‚

æå–è™šæ‹Ÿåˆ—çš„è¿‡ç¨‹å¦‚ä¸‹ï¼š

1. æ”¶é›†è®¿é—®è®¡æ•°è¶…è¿‡ FPGrowth ç®—æ³•ç”Ÿæˆçš„é˜ˆå€¼çš„é”®è·¯å¾„ã€‚
2. è§£æž JSON æ•°æ®ï¼ŒæŽ¨æ–­æ‰€æœ‰é”®è·¯å¾„çš„ JSON schemaï¼ŒåŒ…æ‹¬å€¼çš„ç±»åž‹å’Œè¡Œå·ã€‚
3. æ£€æŸ¥æ‰€æœ‰é”®è·¯å¾„ï¼Œå¦‚æžœå€¼çš„ç±»åž‹ç›¸åŒï¼Œå¹¶ä¸”æ¯è¡Œéƒ½æœ‰æ•°æ®ï¼Œåˆ™ä»Žè¯¥é”®è·¯å¾„æå–æ•°æ®ä»¥ç”Ÿæˆè™šæ‹Ÿåˆ—ï¼Œå¹¶å°†å®ƒä»¬å­˜å‚¨åœ¨å•ç‹¬çš„ parquet æ–‡ä»¶ä¸­ã€‚

ä»¥ä¸‹é¢çš„ JSON ä¸ºä¾‹ã€‚

```json
{"id":1,"title":"a","user":{"id":1,"name":"a"},"tags":["t1","t2"]}
{"id":2,"title":"b","user":{"id":2,"name":"b"},"tags":["t3","t4"]}
{"id":3,"title":"c","user":{"id":3,"name":3}}
{"id":4,"title":"d","user":{"id":4,"name":4}}
```

é”®è·¯å¾„ `id`ã€`title` å’Œ `user:id` å…·æœ‰ç›¸åŒçš„æ•°æ®ç±»åž‹ï¼Œæˆ‘ä»¬å¯ä»¥å°†å®ƒä»¬æå–ä¸ºè™šæ‹Ÿåˆ—ã€‚
å¯¹äºŽ `user.name`ï¼Œå€¼çš„ç±»åž‹ä¸åŒã€‚
å¯¹äºŽ `tags`ï¼Œå®ƒä¸åœ¨æ¯ä¸€è¡Œä¸Šã€‚æˆ‘ä»¬ä¸ä¸ºå®ƒä»¬ç”Ÿæˆè™šæ‹Ÿåˆ—ã€‚

#### å°†é”®è·¯å¾„è®¿é—®ä¸‹æŽ¨åˆ°å­˜å‚¨

æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥è®¿é—® json é”®è·¯å¾„ï¼šç‚¹è¡¨ç¤ºæ³•ï¼Œä¾‹å¦‚ `col:level1:level2` å’Œæ‹¬å·è¡¨ç¤ºæ³•ï¼Œä¾‹å¦‚ `col['level1'][0]`ã€‚

ä¾‹å¦‚ï¼š

```sql
create table test (id int8, v json);
insert into test values(1, parse_json('{"k1":{"k2":"v"},"a":[0,1,2]}'));
select v:k1:k2, v['a'][0] from test;
+---------+-----------+
| v:k1:k2 | v['a'][0] |
+---------+-----------+
| "v"     | 0         |
+---------+-----------+
```

ç›®å‰ï¼ŒJSON é”®è·¯å¾„çš„è®¿é—®å°†è¢«è½¬æ¢ä¸º `get` æ ‡é‡å‡½æ•°ï¼Œå¹¶é€šè¿‡é”®éåŽ† JSON ä»¥èŽ·å–å€¼ã€‚
ä¸ºäº†ä½¿ç”¨è™šæ‹Ÿåˆ—æ¥æé«˜æ€§èƒ½ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹æŸ¥è¯¢è®¡åˆ’å¹¶å°†é”®è·¯å¾„çš„è®¿é—®ä¸‹æŽ¨åˆ°å­˜å‚¨å±‚ã€‚
ç”±äºŽæˆ‘ä»¬ä½¿ç”¨ JSONB è€Œä¸æ˜¯ JSONï¼Œå³ä½¿å¯¹äºŽæ²¡æœ‰ç”Ÿæˆè™šæ‹Ÿåˆ—çš„é”®è·¯å¾„ï¼Œä¸‹æŽ¨åˆ°å­˜å‚¨å±‚ä¹Ÿä¼šå¸¦æ¥å¥½å¤„ã€‚

### JSONB

JSONB ä»£è¡¨ `JSON Binary` æˆ– `JSON better`ï¼Œå®ƒæ˜¯ PostgreSQL v9.4 ä»¥æ¥æ”¯æŒçš„ä¼˜åŒ–äºŒè¿›åˆ¶æ ¼å¼æ•°æ®ç±»åž‹ã€‚
CockroachDB ä¹ŸåŸºäºŽ PostgreSQL è®¾è®¡å®žçŽ°äº† JSONBã€‚

é€šè¿‡å°†æ•°æ®å­˜å‚¨ä¸º JSONB è€Œä¸æ˜¯ JSONï¼Œæˆ‘ä»¬å¯ä»¥èŽ·å¾—ä»¥ä¸‹å¥½å¤„ï¼š

- JSONB çš„è§£æžå’ŒæŸ¥è¯¢è¿‡ç¨‹æ˜Žæ˜¾æ›´å¿«ã€‚
- è®¿é—®ç‰¹å®šçš„é”®è·¯å¾„ä¸éœ€è¦è¯»å–å®Œæ•´çš„æ•°æ®ï¼Œè¿™å°†å¤§å¤§æé«˜æ•´ä½“æ€§èƒ½ã€‚
- å¯ä»¥æ·»åŠ å¤–éƒ¨ç´¢å¼•ä»¥è¿›ä¸€æ­¥åŠ é€ŸæŸ¥è¯¢ã€‚

#### äºŒè¿›åˆ¶ç¼–ç 

JSONB æ˜¯ä¸€ä¸ªæ ‘ç»“æž„ã€‚æ¯ä¸ªèŠ‚ç‚¹ç”±ä¸‰ä¸ªéƒ¨åˆ†ç»„æˆï¼Œä¸€ä¸ª 32 ä½æ ‡å¤´ï¼Œå‡ ä¸ª 32 ä½ `JEntry` å’Œå¯å˜é•¿åº¦çš„åŽŸå§‹å†…å®¹ã€‚

- æ ‡å¤´ä¹Ÿç§°ä¸ºå®¹å™¨æ ‡å¤´ï¼Œå®ƒåŒ…æ‹¬ä¸€ä¸ª 3 ä½ç±»åž‹ï¼ˆåŒ…æ‹¬ `array`ã€`object` å’Œ `scalar`ï¼‰å’Œä¸€ä¸ª 28 ä½æ¥æŒ‡ç¤º `array` æˆ– `object` ä¸­çš„å…ƒç´ æ•°é‡ã€‚
- `JEntry` å…·æœ‰ä¸€ä¸ª 3 ä½å€¼ç±»åž‹ï¼ˆåŒ…æ‹¬ `true`ã€`false`ã€`null`ã€`string`ã€`number`ã€`array` å’Œ `object`ï¼‰ï¼Œä¸€ä¸ª 28 ä½æä¾›åŽŸå§‹å†…å®¹çš„é•¿åº¦æˆ–åç§»é‡ï¼Œä»¥åŠä¸€ä¸ª 1 ä½æ ‡å¿—æ¥æŒ‡ç¤ºæ˜¯å¦ä½¿ç”¨é•¿åº¦æˆ–åç§»é‡ã€‚
- æœ€åŽä¸€éƒ¨åˆ†æ˜¯åŽŸå§‹å†…å®¹å€¼ï¼Œå¯ä»¥é€šè¿‡ `JEntry` ä¸­çš„é•¿åº¦æˆ–åç§»é‡æ¥å®šä½ã€‚

ä»¥ä¸‹é¢çš„ JSON ä¸ºä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° JSONB çš„ç¼–ç æ ¼å¼å¦‚ä¸‹ã€‚

```json
{ "a": 1, "b": [true, 2, "v"] }
```

```
  .--------------.    .-----------------------------------.
  |    header    | -> |    type(object) | item nums(2)    |
  .--------------.    .-----------------------------------.
  | key1 JEntry  | -> | flag | val type(string) | len/off | -+
  .--------------.    .-----------------------------------.  |
  | key2 JEntry  | -> | flag | val type(string) | len/off | -+-+
  .--------------.    .-----------------------------------.  | |
  | val1 JEntry  | -> | flag | val type(number) | len/off | -+-+-+
  .--------------.    .-----------------------------------.  | | |
  | val2 JEntry  | -> | flag | val type(string) | len/off | -+-+-+-+
  .--------------.    .-----------------------------------.  | | | |
  |     "a"      | <-----------------------------------------+ | | |
  .--------------.                                             | | |
  |     "b"      | <-------------------------------------------+ | |
  .--------------.                                               | |
  |      1       | <---------------------------------------------+ |
  .--------------.                                                 |
  | [true,2,"v"] | <-----------------------------------------------+
  .--------------.
        |           .--------------+    .-----------------------------------.
        +---------> |    header    | -> |    type(array) | item nums(3)     |
                    .--------------+    .-----------------------------------.
                    | item1 JEntry | -> | flag | val type(bool true)        |
                    .--------------+    .-----------------------------------.
                    | item2 JEntry | -> | flag | val type(number) | len/off | -+
                    .--------------+    .-----------------------------------.  |
                    | item3 JEntry | -> | flag | val type(string) | len/off | -+-+
                    .--------------+    .-----------------------------------.  | |
                    |      2       | <-----------------------------------------+ |
                    .--------------.                                             |
                    |     "v"      | <-------------------------------------------+
                    .--------------.
```

æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜… [PostgreSQL](https://github.com/postgres/postgres/blob/master/src/include/utils/jsonb.h)
å’Œ [CockroachDB](https://github.com/cockroachdb/cockroach/blob/master/docs/RFCS/20171005_jsonb_encoding.md) çš„è®¾è®¡

å—ç›ŠäºŽ JSONB çš„æ ‘ç»“æž„ï¼Œæœç´¢é”®è·¯å¾„åªéœ€è¦è§£æžéƒ¨åˆ†å®Œæ•´æ•°æ®ã€‚
åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸­ï¼Œå¯¹è±¡é”®å¯ä»¥åœ¨ O(ð‘™ð‘œð‘”(ð‘›)) ä¸­è®¿é—®ï¼Œå› ä¸ºé”®å·²æŽ’åºå¹¶ä¸”å¯ä»¥ä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾ï¼Œå¹¶ä¸”æ•°ç»„å…ƒç´ å¯ä»¥åœ¨ O(1) ä¸­è®¿é—®ï¼Œå› ä¸º JEntry çš„é•¿åº¦æ˜¯å›ºå®šçš„ã€‚

## ç¼ºç‚¹

- æå–è™šæ‹Ÿåˆ—éœ€è¦é¢å¤–çš„å¼‚æ­¥ä»»åŠ¡ã€‚
- JSONB å¯èƒ½æ¯” JSON å ç”¨æ›´å¤šçš„ç£ç›˜ç©ºé—´ã€‚

## åŽŸç†å’Œæ›¿ä»£æ–¹æ¡ˆ

[BSON](http://bsonspec.org) æ˜¯ MongoDB ä¸­ä½¿ç”¨çš„äºŒè¿›åˆ¶ JSON æ ¼å¼ã€‚
å®ƒçš„ä¸»è¦è®¾è®¡ç›®æ ‡æ˜¯å­˜å‚¨æ–‡æ¡£ï¼Œå› æ­¤å®ƒåœ¨æ ‡å¤´ä¸­æ²¡æœ‰é”®è·¯å¾„çš„ç´¢å¼•ã€‚

[ION](https://amzn.github.io/ion-docs/) ä¹Ÿæ˜¯ç”±äºšé©¬é€Šå¼€å‘çš„äºŒè¿›åˆ¶ JSON æ ¼å¼ã€‚
å®ƒé’ˆå¯¹è¯»å–è¿›è¡Œäº†ä¼˜åŒ–ï¼Œå¹¶å…·æœ‰ç¬¦å·è¡¨ä½œä¸ºç´¢å¼•ä»¥åŠ é€Ÿé”®è·¯å¾„è®¿é—®ã€‚
å®ƒçš„ä¸»è¦é—®é¢˜æ˜¯ Rust ç‰ˆæœ¬çš„å¼€å‘ä»å¤„äºŽæ—©æœŸé˜¶æ®µï¼Œå¹¶ä¸”ç¼ºå°‘ä¸€äº›é‡è¦çš„ trait æ”¯æŒï¼Œä¾‹å¦‚ `serde`ã€‚

è¿˜æœ‰ä¸€äº›é’ˆå¯¹çº¯æ–‡æœ¬ json çš„ä¼˜åŒ–ï¼Œä¾‹å¦‚
[simd-json](https://github.com/simd-lite/simd-json) ä½¿ç”¨ SIMD æŒ‡ä»¤æ¥åŠ é€Ÿè§£æžï¼Œ
[Pison](https://github.com/AutomataLab/Pison) é€šè¿‡æ·»åŠ ä½å›¾ç´¢å¼•æ¥åŠ é€Ÿè§£æžã€‚
ä½†å®ƒä»¬é’ˆå¯¹å®Œæ•´æ•°æ®çš„è§£æžè¿›è¡Œäº†ä¼˜åŒ–ï¼Œè¿™æ— åŠ©äºŽåŠ é€ŸæŒ‰é”®è·¯å¾„è®¿é—®ã€‚

## å…ˆå‰æŠ€æœ¯

æœ¬ RFC çš„ä¸»è¦æ€æƒ³æ¥è‡ª [JSON Tiles](https://db.in.tum.de/people/sites/durner/papers/json-tiles-sigmod21.pdf) è®ºæ–‡ã€‚
è¯¥è®ºæ–‡ä¸­çš„å®žéªŒè¯„ä¼°è¡¨æ˜Žï¼Œè¿™äº›ä¼˜åŒ–å¯ä»¥æœ‰æ•ˆåœ°æé«˜ JSON æ•°æ®çš„è¯»å–æ€§èƒ½ã€‚

PostgreSQL å’Œ CockroachDB éƒ½ä½¿ç”¨ JSONB ä½œä¸ºä¼˜åŒ–çš„ JSON æ ¼å¼ï¼Œæˆ‘ä»¬å¯ä»¥åŸºäºŽå®ƒä»¬çš„è®¾è®¡å®žçŽ° Rust ç‰ˆæœ¬çš„ JSONBã€‚

## æœªè§£å†³çš„é—®é¢˜

æ— ã€‚

## æœªæ¥å¯èƒ½æ€§

- æå–å…·æœ‰ä¸åŒæ•°æ®ç±»åž‹å€¼çš„é”®è·¯å¾„çš„è™šæ‹Ÿåˆ—
- ä¸º JSONB æ·»åŠ é¢å¤–çš„ç´¢å¼•
