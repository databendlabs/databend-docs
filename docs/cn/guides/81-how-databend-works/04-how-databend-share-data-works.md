---
title: Databend 无副本数据共享的工作原理
---

## 什么是数据共享？

不同的团队需要同一份数据的不同部分。传统解决方案会多次复制数据，这不仅成本高昂，而且难以维护。

Databend 的 **[ATTACH TABLE](/sql/sql-commands/ddl/table/attach-table)** 命令优雅地解决了这个问题：它可以在不复制数据的情况下，为同一份数据创建多个“视图”。这得益于 Databend **真正的存算分离**架构——无论使用云存储还是本地对象存储，都能实现**一次存储，随处访问**。

可以将 ATTACH TABLE 理解为计算机中的快捷方式——它们指向原始文件，而不会复制文件本身。

```
                   对象存储（S3、MinIO、Azure 等）
                         ┌─────────────┐
                         │  你的数据   │
                         └──────┬──────┘
                                │
        ┌───────────────────────┼───────────────────────┐
        │                       │                       │
        ▼                       ▼                       ▼
┌─────────────┐         ┌─────────────┐         ┌─────────────┐
│  市场团队   │         │  财务团队   │         │  销售团队   │
│  团队视图   │         │  团队视图   │         │  团队视图   │
└─────────────┘         └─────────────┘         └─────────────┘
```

## 如何使用 ATTATCH TABLE

**步骤 1：查找数据位置**
```sql
SELECT snapshot_location FROM FUSE_SNAPSHOT('default', 'company_sales');
-- 结果：1/23351/_ss/... → 数据位于 s3://your-bucket/1/23351/
```

**步骤 2：创建特定于团队的视图**
```sql
-- 市场部：客户行为分析
ATTACH TABLE marketing_view (customer_id, product, amount, order_date) 
's3://your-bucket/1/23351/' CONNECTION = (ACCESS_KEY_ID = 'xxx', SECRET_ACCESS_KEY = 'yyy');

-- 财务部：收入跟踪
ATTACH TABLE finance_view (order_id, amount, profit, order_date) 
's3://your-bucket/1/23351/' CONNECTION = (ACCESS_KEY_ID = 'xxx', SECRET_ACCESS_KEY = 'yyy');

-- 人力资源部：不含薪资的员工信息
ATTACH TABLE hr_employees (employee_id, name, department) 
's3://data/1/23351/' CONNECTION = (...);

-- 开发部：不含敏感数据的生产环境表结构
ATTACH TABLE dev_customers (customer_id, country, created_date) 
's3://data/1/23351/' CONNECTION = (...);
```

**步骤 3：独立查询**
```sql
-- 市场部进行趋势分析
SELECT product, COUNT(*) FROM marketing_view GROUP BY product;

-- 财务部跟踪利润
SELECT order_date, SUM(profit) FROM finance_view GROUP BY order_date;
```

## 核心优势

**实时更新**：源数据发生变化时，所有附加表都能即时看到更新。
```sql
INSERT INTO company_sales VALUES (1001, 501, 'Laptop', 1299.99, 299.99, 'user@email.com', '2025-01-20');
SELECT COUNT(*) FROM marketing_view WHERE order_date = '2024-01-20'; -- 返回：1
```

**列级安全性**：团队只能看到他们需要的数据——市场部看不到利润，财务部看不到客户电子邮件。

**强一致性**：永远不会读取到部分更新，总是能看到完整的快照——非常适合财务报告和合规性要求。

**完整性能**：所有索引（Index）自动生效，查询速度与普通表相同。

## 为何如此重要

| 传统方法 | Databend ATTACH TABLE |
|---------------------|----------------------|
| 多份数据副本 | 单一副本，多方共享 |
| ETL 延迟，同步问题 | 实时，始终最新 |
| 维护复杂 | 零维护 |
| 副本越多，安全风险越高 | 细粒度的列级访问控制 |
| 数据移动导致速度慢 | 基于原始数据进行全面优化 |

## 底层工作原理

```
查询（Query）: SELECT product, SUM(amount) FROM marketing_view GROUP BY product

┌─────────────────────────────────────────────────────────────────┐
│                         查询执行流程                          │
└─────────────────────────────────────────────────────────────────┘

    用户查询
        │
        ▼
┌───────────────────┐    ┌─────────────────────────────────────┐
│  1. 读取快照    │───►│           获取当前表状态            │
│     元数据      │    │                                     │
└───────────────────┘    └─────────────────────────────────────┘
        │
        ▼
┌───────────────────┐    ┌─────────────────────────────────────┐
│   2. 应用列     │───►│   过滤器：customer_id,    │
│    过滤器       │    │ product, amount, order_date         │
└───────────────────┘    └─────────────────────────────────────┘
        │
        ▼
┌───────────────────┐    ┌─────────────────────────────────────┐
│ 3. 检查统计信息 │───►│ • 数据块的 min/max 值           │
│     和索引      │    │ • 布隆过滤器（Bloom filters）   │
└───────────────────┘    │ • 聚合索引（Aggregate indexes） │
        │                └─────────────────────────────────────┘
        ▼
┌───────────────────┐    ┌─────────────────────────────────────┐
│  4. 智能数据    │───►│        跳过不相关的数据块         │
│      抓取       │    │      仅从 _b/ 下载所需数据      │
└───────────────────┘    └─────────────────────────────────────┘
        │
        ▼
┌───────────────────┐    ┌─────────────────────────────────────┐
│    5. 本地      │───►│         全面优化和并行化          │
│      执行       │    │      使用所有可用索引进行处理     │
└───────────────────┘    └─────────────────────────────────────┘
        │
        ▼
    结果：产品销售摘要
```

多个 Databend 计算集群（Warehouse）可以同时执行此流程而无需协调——这正是存算分离架构的实际体现。

ATTACH TABLE 代表了一种根本性的转变：**从为每个用例复制数据，转变为一个副本、多个视图**。无论是在云上还是本地环境中，Databend 的架构都能实现强大、高效的数据共享，同时保持企业级的一致性和安全性。