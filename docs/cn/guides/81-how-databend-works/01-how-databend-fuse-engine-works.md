---
title: Fuse 引擎的工作原理
---

## Fuse 引擎

Fuse 引擎是 Databend 的核心存储引擎，专为在**云对象存储**上高效管理 **PB 级**数据而优化。默认情况下，在 Databend 中创建的表会自动使用此引擎（`ENGINE=FUSE`）。受 Git 启发，其基于快照的设计支持强大的数据版本控制（如时间回溯（Time Travel）），并通过先进的剪枝和索引技术提供**高查询性能**。

本文档阐述其核心概念与工作原理。

## 核心概念

Fuse 引擎采用三种核心数据结构组织数据，与 Git 架构对应：

*   **快照（Snapshot）（类似 Git 提交）：** 通过指向特定段（Segment）定义表在时间点的状态，为不可变引用。支持时间回溯（Time Travel）。
*   **段（Segment）（类似 Git 树）：** 包含统计摘要的块（Block）集合，用于快速数据跳过（剪枝）。可在多个快照间共享。
*   **块（Block）（类似 Git Blob）：** 存储实际数据的不可变文件（Parquet 格式），包含行数据及列级统计信息，支持细粒度剪枝。

```
                         表头
                             │
                             ▼
     ┌───────────────┐     ┌───────────────┐     ┌───────────────┐
     │    段 A       │◄────│   快照 2      │────►│    段 B       │
     │               │     │ 前一版本:     │     │               │
     └───────┬───────┘     │ 快照 1        │     └───────┬───────┘
             │             └───────────────┘             │
             │                     │                     │
             │                     ▼                     │
             │             ┌───────────────┐             │
             │             │   快照 1      │             │
             │             │               │             │
             │             └───────────────┘             │
             │                                           │
             ▼                                           ▼
     ┌───────────────┐                           ┌───────────────┐
     │    块 1       │                           │    块 2       │
     │ (cloud.txt)   │                           │(warehouse.txt)│
     └───────────────┘                           └───────────────┘
```

## 写入工作原理

向表添加数据时，Fuse 引擎会创建对象链，流程如下：

### 步骤 1：创建表

```sql
CREATE TABLE git(file VARCHAR, content VARCHAR);
```

此时表结构存在但无数据：

```
（空表，无数据）
```

### 步骤 2：插入首条数据

```sql
INSERT INTO git VALUES('cloud.txt', '2022/05/06, Databend, Cloud');
```

首次插入后生成初始快照、段和块：

```
         表头
             │
             ▼
     ┌───────────────┐
     │   快照 1      │
     │               │
     └───────┬───────┘
             │
             ▼
     ┌───────────────┐
     │    段 A       │
     │               │
     └───────┬───────┘
             │
             ▼
     ┌───────────────┐
     │    块 1       │
     │ (cloud.txt)   │
     └───────────────┘
```

### 步骤 3：插入更多数据

```sql
INSERT INTO git VALUES('warehouse.txt', '2022/05/07, Databend, Warehouse');
```

新增数据时创建新快照，同时引用原始段和新段：

```
                         表头
                             │
                             ▼
     ┌───────────────┐     ┌───────────────┐     ┌───────────────┐
     │    段 A       │◄────│   快照 2      │────►│    段 B       │
     │               │     │ 前一版本:     │     │               │
     └───────┬───────┘     │ 快照 1        │     └───────┬───────┘
             │             └───────────────┘             │
             │                     │                     │
             │                     ▼                     │
             │             ┌───────────────┐             │
             │             │   快照 1      │             │
             │             │               │             │
             │             └───────────────┘             │
             │                                           │
             ▼                                           ▼
     ┌───────────────┐                           ┌───────────────┐
     │    块 1       │                           │    块 2       │
     │ (cloud.txt)   │                           │(warehouse.txt)│
     └───────────────┘                           └───────────────┘
```

## 读取工作原理

查询数据时，Fuse 引擎通过智能剪枝高效定位目标数据：

```
查询：SELECT * FROM git WHERE file = 'cloud.txt';

                         表头
                             │
                             ▼
     ┌───────────────┐     ┌───────────────┐     ┌───────────────┐
     │    段 A       │◄────│   快照 2      │────►│    段 B       │
     │    检查       │     │               │     │    检查       │
     └───────┬───────┘     └───────────────┘     └───────────────┘
             │                                          ✗
             │                                    （跳过 - 不包含
             │                                     'cloud.txt'）
             ▼
     ┌───────────────┐
     │    块 1       │
     │    检查       │
     └───────┬───────┘
             │
             │ ✓ （包含 'cloud.txt'）
             ▼
        读取此块
```

### 智能剪枝流程

```
┌─────────────────────────────────────────┐
│ 查询：WHERE file = 'cloud.txt'          │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│ 检查段 A                                │
│ 文件最小值：'cloud.txt'                 │
│ 文件最大值：'cloud.txt'                 │
│                                         │
│ 结果：✓ 可能包含 'cloud.txt'            │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│ 检查段 B                                │
│ 文件最小值：'warehouse.txt'             │
│ 文件最大值：'warehouse.txt'             │
│                                         │
│ 结果：✗ 不可能包含 'cloud.txt'          │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│ 检查段 A 中的块 1                       │
│ 文件最小值：'cloud.txt'                 │
│ 文件最大值：'cloud.txt'                 │
│                                         │
│ 结果：✓ 包含 'cloud.txt'                │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│ 仅读取块 1                              │
└─────────────────────────────────────────┘
```

## 基于快照的功能

Fuse 引擎的快照架构支持以下高级数据管理能力：

### 时间回溯（Time Travel）

查询历史任意时间点的数据状态，支持数据分支、标记和治理，提供完整审计追踪与错误恢复能力。

### 零拷贝模式演进

**无需重写底层数据文件**即可修改表结构（增删列、重命名、类型变更）：

- 变更仅记录为新快照中的元数据操作
- 操作瞬时完成，无需停机，避免高成本数据迁移
- 历史数据仍可通过原始模式访问

## 查询加速的高级索引（Fuse 引擎）

除基础块/段剪枝外，Fuse 引擎提供专用二级索引加速特定查询场景：

| 索引类型                | 功能描述                                          | 加速场景                                     | 查询示例                            |
| :---------------------- | :------------------------------------------------ | :------------------------------------------- | :---------------------------------- |
| **聚合索引（Aggregate Index）** | 预计算指定分组的聚合结果                       | `COUNT`/`SUM`/`AVG` + `GROUP BY`             | `SELECT COUNT(*)... GROUP BY city`  |
| **全文索引（Full-Text Index）** | 文本关键词搜索倒排索引                        | `MATCH` 文本检索（如日志分析）               | `WHERE MATCH(log_entry, 'error')`   |
| **JSON 索引（JSON Index）**      | 索引 JSON 文档内特定路径/键值                 | JSON 路径/值过滤                             | `WHERE event_data:user.id = 123`    |
| **布隆过滤器索引（Bloom Filter Index）** | 概率型块跳过检查                          | 点查询（`=`）及 `IN` 列表过滤                | `WHERE user_id = 'xyz'`             |

## 对比：Databend Fuse 引擎 vs. Apache Iceberg

_**注意：** 本对比聚焦**表格式特性**。作为 Databend 原生表格式，Fuse 持续演进以提升**可用性与性能**。功能列表基于当前版本，后续可能变更。_

| 功能                 | Apache Iceberg                     | Databend Fuse 引擎                 |
| :------------------- | :--------------------------------- | :--------------------------------- |
| **元数据结构**       | 清单列表 → 清单文件 → 数据文件     | **快照** → 段 → 块                 |
| **统计层级**         | 文件级（+分区）                    | **多层级**（快照/段/块）→ 精细剪枝 |
| **剪枝能力**         | 良好（文件/分区统计）              | **优秀**（多级统计+二级索引）      |
| **模式演进**         | 支持（元数据变更）                 | **零拷贝**（元数据操作，瞬时完成） |
| **数据聚簇**         | 写入时排序                         | **自动优化**（后台执行）           |
| **流式支持**         | 基础流式摄取                       | **高级增量处理**（插入/更新追踪）  |