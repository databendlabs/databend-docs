---
title: Fuse Engine 工作原理
---

## Fuse Engine

Fuse Engine 是 Databend 的核心存储引擎，专为在**云对象存储**上高效管理**PB级**数据而优化。默认情况下，在 Databend 中创建的表会自动使用此引擎 (`ENGINE=FUSE`)。其设计灵感源自 Git，基于快照的架构实现了强大的数据版本控制（如时间回溯），并通过高级剪枝和索引技术提供**卓越的查询性能**。

本文档将阐述其核心概念及工作原理。


## 核心概念

Fuse Engine 采用类似 Git 的三层数据结构组织数据：

*   **快照（类似 Git Commit）**：不可变引用，通过指向特定 Segment 来定义表在某一时刻的状态。支持时间回溯功能。
*   **段（类似 Git Tree）**：包含数据块集合及摘要统计信息，用于快速数据跳过（剪枝）。可被多个快照共享。
*   **块（类似 Git Blob）**：存储实际数据的不可变文件（Parquet 格式），包含详细列级统计信息以实现细粒度剪枝。


```
                         Table HEAD
                             │
                             ▼
     ┌───────────────┐     ┌───────────────┐     ┌───────────────┐
     │  SEGMENT A    │◄────│  SNAPSHOT 2   │────►│  SEGMENT B    │
     │               │     │ Previous:     │     │               │
     └───────┬───────┘     │ SNAPSHOT 1    │     └───────┬───────┘
             │             └───────────────┘             │
             │                     │                     │
             │                     ▼                     │
             │             ┌───────────────┐             │
             │             │  SNAPSHOT 1   │             │
             │             │               │             │
             │             └───────────────┘             │
             │                                           │
             ▼                                           ▼
     ┌───────────────┐                           ┌───────────────┐
     │   BLOCK 1     │                           │   BLOCK 2     │
     │ (cloud.txt)   │                           │(warehouse.txt)│
     └───────────────┘                           └───────────────┘
```



## 写入流程

当向表添加数据时，Fuse Engine 会创建一系列关联对象。以下是分步说明：

### 第一步：创建表

```sql
CREATE TABLE git(file VARCHAR, content VARCHAR);
```

此时表已存在但不含数据：

```
(空表无数据)
```

### 第二步：首次插入数据

```sql
INSERT INTO git VALUES('cloud.txt', '2022/05/06, Databend, Cloud');
```

首次插入后，Fuse Engine 会创建初始快照、段和块：

```
         Table HEAD
             │
             ▼
     ┌───────────────┐
     │  SNAPSHOT 1   │
     │               │
     └───────┬───────┘
             │
             ▼
     ┌───────────────┐
     │  SEGMENT A    │
     │               │
     └───────┬───────┘
             │
             ▼
     ┌───────────────┐
     │   BLOCK 1     │
     │ (cloud.txt)   │
     └───────────────┘
```

### 第三步：追加数据

```sql
INSERT INTO git VALUES('warehouse.txt', '2022/05/07, Databend, Warehouse');
```

再次插入时，Fuse Engine 会创建引用原始段和新段的新快照：

```
                         Table HEAD
                             │
                             ▼
     ┌───────────────┐     ┌───────────────┐     ┌───────────────┐
     │  SEGMENT A    │◄────│  SNAPSHOT 2   │────►│  SEGMENT B    │
     │               │     │ Previous:     │     │               │
     └───────┬───────┘     │ SNAPSHOT 1    │     └───────┬───────┘
             │             └───────────────┘             │
             │                     │                     │
             │                     ▼                     │
             │             ┌───────────────┐             │
             │             │  SNAPSHOT 1   │             │
             │             │               │             │
             │             └───────────────┘             │
             │                                           │
             ▼                                           ▼
     ┌───────────────┐                           ┌───────────────┐
     │   BLOCK 1     │                           │   BLOCK 2     │
     │ (cloud.txt)   │                           │(warehouse.txt)│
     └───────────────┘                           └───────────────┘
```

## 读取流程

执行查询时，Fuse Engine 通过智能剪枝高效定位数据：

```
Query: SELECT * FROM git WHERE file = 'cloud.txt';

                         Table HEAD
                             │
                             ▼
     ┌───────────────┐     ┌───────────────┐     ┌───────────────┐
     │  SEGMENT A    │◄────│  SNAPSHOT 2   │────►│  SEGMENT B    │
     │    CHECK      │     │               │     │    CHECK      │
     └───────┬───────┘     └───────────────┘     └───────────────┘
             │                                          ✗
             │                                    (跳过 - 不含
             │                                     'cloud.txt')
             ▼
     ┌───────────────┐
     │   BLOCK 1     │
     │    CHECK      │
     └───────┬───────┘
             │
             │ ✓ (包含 'cloud.txt')
             ▼
        读取该数据块
```

### 智能剪枝过程

```
┌─────────────────────────────────────────┐
│ 查询条件: WHERE file = 'cloud.txt'      │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│ 检查 SEGMENT A                          │
│ 最小 file 值: 'cloud.txt'               │
│ 最大 file 值: 'cloud.txt'               │
│                                         │
│ 结论: ✓ 可能包含 'cloud.txt'            │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│ 检查 SEGMENT B                          │
│ 最小 file 值: 'warehouse.txt'           │
│ 最大 file 值: 'warehouse.txt'           │
│                                         │
│ 结论: ✗ 不可能包含 'cloud.txt'          │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│ 检查 SEGMENT A 中的 BLOCK 1             │
│ 最小 file 值: 'cloud.txt'               │
│ 最大 file 值: 'cloud.txt'               │
│                                         │
│ 结论: ✓ 包含 'cloud.txt'                │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│ 仅读取 BLOCK 1                          │
└─────────────────────────────────────────┘
```

## 基于快照的特性

Fuse Engine 的快照架构支持强大的数据管理能力：

### 时间回溯

## 时间回溯查询

可查询任意时间点的历史数据。通过完整审计追踪和错误恢复机制，实现数据分支、标记和治理能力。

### 零拷贝模式演进

**无需重写底层数据文件**即可修改表结构（增删列、重命名、类型变更）：

- 变更仅记录为新快照的元数据操作
- 操作瞬时完成，无需停机，避免高昂的数据迁移任务。旧数据仍可通过原始模式访问

## 查询加速高级索引（Fuse 引擎）

除基于统计的基础块/段剪枝外，Fuse 引擎提供专用二级索引进一步加速特定查询模式：

| 索引类型          | 简要描述                                         | 加速查询示例                         | 查询片段示例                   |
| :------------------ | :-------------------------------------------------------- | :-------------------------------------------------- | :-------------------------------------- |
| **聚合索引** | 预计算指定分组的聚合结果       | 加速 `COUNT`、`SUM`、`AVG`... + `GROUP BY`          | `SELECT COUNT(*)... GROUP BY city`      |
| **全文索引** | 为文本内容建立倒排索引实现快速关键词检索        | 使用 `MATCH` 的文本搜索（如日志）              | `WHERE MATCH(log_entry, 'error')`     |
| **JSON索引**      | 为JSON文档内特定路径/键建立索引       | 基于JSON路径/值的筛选             | `WHERE event_data:user.id = 123`      |
| **布隆过滤器索引** | 概率性检查快速跳过不匹配数据块 | 加速等值查询（`=`）及 `IN` 列表筛选      | `WHERE user_id = 'xyz'` |

## 对比：Databend Fuse 引擎 vs Apache Iceberg

_**注意**：本对比聚焦**表格式特性**。作为Databend原生表格式，Fuse持续演进以提升**易用性与性能**。所示特性为当前版本，后续可能变更。_

| 特性                 | Apache Iceberg                     | Databend Fuse 引擎                 |
| :---------------------- | :--------------------------------- | :----------------------------------- |
| **元数据结构**  | 清单列表 -> 清单文件 -> 数据文件 | **快照** -> 段 -> 块   |
| **统计层级**   | 文件级（+分区）            | **多层级**（快照、段、块）→ 更精细剪枝 |
| **剪枝能力**       | 良好（文件/分区统计）      | **卓越**（多级统计 + 二级索引） |
| **模式演进**    | 支持（元数据变更）        | **零拷贝**（仅元数据变更，瞬时完成） |
| **数据聚类**     | 写入时排序     | **自动**优化（后台执行） |
| **流式支持**   | 基础流式摄入          | **高级增量处理**（插入/更新追踪） |