title: Fuse 引擎工作原理
---

## Fuse 引擎

Fuse 引擎是 Databend 的核心存储引擎，专为在**云对象存储**上高效管理**PB 级**数据而优化。默认情况下，在 Databend 中创建的表会自动使用此引擎（`ENGINE=FUSE`）。其设计灵感源于 Git，基于快照的设计支持强大的数据版本控制（例如时间回溯 (Time Travel)），并通过先进的剪枝和索引技术提供**高查询性能**。

本文将介绍其核心概念与工作原理。


## 核心概念

Fuse 引擎使用三个核心结构来组织数据，其设计类似 Git：

*   **快照 (Snapshot)**（类似 Git 的提交）：不可变的引用，通过指向特定的段 (Segment) 来定义表在某个时间点的状态。支持时间回溯 (Time Travel)。
*   **段 (Segment)**（类似 Git 的树）：块 (Block) 的集合，包含用于快速数据跳过（剪枝）的摘要统计信息。可以在快照间共享。
*   **块 (Block)**（类似 Git 的 Blob）：不可变的数据文件（Parquet 格式），保存实际的行数据和详细的列级统计信息，用于细粒度剪枝。


```
                         表头 (Table HEAD)
                             │
                             ▼
     ┌───────────────┐     ┌───────────────┐     ┌───────────────┐
     │      段 A     │◄────│    快照 2     │────►│      段 B     │
     │               │     │   上一个:     │     │               │
     └───────┬───────┘     │    快照 1     │     └───────┬───────┘
             │             └───────────────┘             │
             │                     │                     │
             │                     ▼                     │
             │             ┌───────────────┐             │
             │             │    快照 1     │             │
             │             │               │             │
             │             └───────────────┘             │
             │                                           │
             ▼                                           ▼
     ┌───────────────┐                           ┌───────────────┐
     │     块 1      │                           │     块 2      │
     │ (cloud.txt)   │                           │(warehouse.txt)│
     └───────────────┘                           └───────────────┘
```



## 写入工作原理

当您向表中添加数据时，Fuse 引擎会创建一个对象链。让我们逐步了解这个过程：

### 步骤 1：创建表

```sql
CREATE TABLE git(file VARCHAR, content VARCHAR);
```

此时，表已存在但不包含任何数据：

```
（空表，无数据）
```

### 步骤 2：插入第一条数据

```sql
INSERT INTO git VALUES('cloud.txt', '2022/05/06, Databend, Cloud');
```

第一次插入后，Fuse 引擎会创建初始的快照、段和块：

```
         表头 (Table HEAD)
             │
             ▼
     ┌───────────────┐
     │    快照 1     │
     │               │
     └───────┬───────┘
             │
             ▼
     ┌───────────────┐
     │      段 A     │
     │               │
     └───────┬───────┘
             │
             ▼
     ┌───────────────┐
     │     块 1      │
     │ (cloud.txt)   │
     └───────────────┘
```

### 步骤 3：插入更多数据

```sql
INSERT INTO git VALUES('warehouse.txt', '2022/05/07, Databend, Warehouse');
```

当我们插入更多数据时，Fuse 引擎会创建一个新的快照，该快照引用原始段和一个新段：

```
                         表头 (Table HEAD)
                             │
                             ▼
     ┌───────────────┐     ┌───────────────┐     ┌───────────────┐
     │      段 A     │◄────│    快照 2     │────►│      段 B     │
     │               │     │   上一个:     │     │               │
     └───────┬───────┘     │    快照 1     │     └───────┬───────┘
             │             └───────────────┘             │
             │                     │                     │
             │                     ▼                     │
             │             ┌───────────────┐             │
             │             │    快照 1     │             │
             │             │               │             │
             │             └───────────────┘             │
             │                                           │
             ▼                                           ▼
     ┌───────────────┐                           ┌───────────────┐
     │     块 1      │                           │     块 2      │
     │ (cloud.txt)   │                           │(warehouse.txt)│
     └───────────────┘                           └───────────────┘
```

## 读取工作原理

当您查询数据时，Fuse 引擎使用智能剪枝来高效地查找您的数据：

```
查询: SELECT * FROM git WHERE file = 'cloud.txt';

                         表头 (Table HEAD)
                             │
                             ▼
     ┌───────────────┐     ┌───────────────┐     ┌───────────────┐
     │      段 A     │◄────│    快照 2     │────►│      段 B     │
     │      检查     │     │               │     │      检查     │
     └───────┬───────┘     └───────────────┘     └───────────────┘
             │                                          ✗
             │                                    （跳过 - 不包含
             │                                     'cloud.txt'）
             ▼
     ┌───────────────┐
     │     块 1      │
     │      检查     │
     └───────┬───────┘
             │
             │ ✓ （包含 'cloud.txt'）
             ▼
        读取此块
```

### 智能剪枝过程

```
┌─────────────────────────────────────────┐
│ 查询: WHERE file = 'cloud.txt'          │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│ 检查段 A                                │
│ 最小文件值: 'cloud.txt'                 │
│ 最大文件值: 'cloud.txt'                 │
│                                         │
│ 结果: ✓ 可能包含 'cloud.txt'            │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│ 检查段 B                                │
│ 最小文件值: 'warehouse.txt'             │
│ 最大文件值: 'warehouse.txt'             │
│                                         │
│ 结果: ✗ 不可能包含 'cloud.txt'          │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│ 检查段 A 中的块 1                       │
│ 最小文件值: 'cloud.txt'                 │
│ 最大文件值: 'cloud.txt'                 │
│                                         │
│ 结果: ✓ 包含 'cloud.txt'                │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│ 仅读取块 1                              │
└─────────────────────────────────────────┘
```

## 基于快照的功能

Fuse 引擎的快照架构支持强大的数据管理功能：

### 时间回溯 (Time Travel)

查询数据在任意时间点的状态。支持数据分支、标记和治理，并提供完整的审计跟踪和错误恢复。

### 零拷贝模式演进 (Zero-Copy Schema Evolution)

修改您的表结构（添加列、删除列、重命名、更改类型）**无需重写任何底层数据文件**。

- 这些变更是仅涉及元数据的操作，会被记录在新的快照中。
- 此操作是瞬时完成的，无需停机，并避免了成本高昂的数据迁移。旧数据仍可通过其原始模式进行访问。


## 用于查询加速的高级索引（Fuse 引擎）

除了使用统计信息进行基本的块/段剪枝外，Fuse 引擎还提供专门的二级索引来进一步加速特定的查询模式：

| 索引类型                 | 简要描述                                          | 加速的查询类型...                                   | 示例查询片段                            |
| :------------------- | :-------------------------------------------------- | :-------------------------------------------------- | :-------------------------------------- |
| **聚合索引 (Aggregate Index)** | 为指定分组预计算聚合结果                          | 更快的 `COUNT`、`SUM`、`AVG`... + `GROUP BY`          | `SELECT COUNT(*)... GROUP BY city`      |
| **全文索引 (Full-Text Index)** | 用于在文本中进行快速关键词搜索的倒排索引          | 使用 `MATCH` 的文本搜索（例如日志）                 | `WHERE MATCH(log_entry, 'error')`     |
| **JSON 索引 (JSON Index)**     | 索引 JSON 文档中的特定路径或键                    | 过滤特定 JSON 路径或值                              | `WHERE event_data:user.id = 123`      |
| **布隆过滤器索引 (Bloom Filter Index)** | 通过概率性检查快速跳过不匹配的数据块              | 快速点查找 (`=`) 和 `IN` 列表过滤                   | `WHERE user_id = 'xyz'` |



## 对比：Databend Fuse 引擎 vs. Apache Iceberg

_**注意：** 此对比专门关注**表格式 (Table Format)** 的功能。作为 Databend 的原生表格式，Fuse 引擎在持续演进，旨在提升**可用性与性能**。表中展示的是当前版本的功能，未来可能会发生变化。_

| 功能                    | Apache Iceberg                     | Databend Fuse 引擎                   |
| :---------------------- | :--------------------------------- | :----------------------------------- |
| **元数据结构**          | Manifest Lists -> Manifest Files -> Data Files | **快照 (Snapshot)** -> 段 (Segment) -> 块 (Block)   |
| **统计级别**            | 文件级（+分区）                    | **多级**（快照、段、块）→ 更精细的剪枝 |
| **剪枝能力**            | 良好（文件/分区统计数据）          | **优秀**（多级统计数据 + 二级索引）   |
| **模式演进**            | 支持（元数据更改）                 | **零拷贝**（仅元数据，瞬时完成）      |
| **数据聚簇**            | 排序（写入时）                     | **自动**优化（后台）                 |
| **流式支持**            | 基本流式摄取                       | **高级增量**（插入/更新跟踪）         |