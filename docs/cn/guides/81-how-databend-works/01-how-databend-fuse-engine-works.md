---
title: Fuse Engine 工作原理
---

## Fuse Engine

Fuse Engine 是 Databend 的核心存储引擎，专为在**云对象存储**上高效管理 **PB 级**数据而优化。默认情况下，在 Databend 中创建的表会自动使用此引擎（`ENGINE=FUSE`）。受 Git 启发，其基于快照的设计支持强大的数据版本控制（如时间回溯），并通过先进的剪枝和索引提供**高查询性能**。

本文档解释其核心概念和工作原理。

## 核心概念

Fuse Engine 使用三个核心结构组织数据，与 Git 类似：

*   **快照（Snapshot）（类似 Git 提交）：** 不可变的引用，通过指向特定段定义表在某个时间点的状态。支持时间回溯。
*   **段（Segment）（类似 Git 树）：** 块的集合，包含用于快速数据跳过（剪枝）的汇总统计信息。可在快照间共享。
*   **块（Block）（类似 Git blob）：** 不可变的数据文件（Parquet 格式），保存实际行数据和详细的列级统计信息，用于细粒度剪枝。

```
                         Table HEAD
                             │
                             ▼
     ┌───────────────┐     ┌───────────────┐     ┌───────────────┐
     │  SEGMENT A    │◄────│  SNAPSHOT 2   │────►│  SEGMENT B    │
     │               │     │ Previous:     │     │               │
     └───────┬───────┘     │ SNAPSHOT 1    │     └───────┬───────┘
             │             └───────────────┘             │
             │                     │                     │
             │                     ▼                     │
             │             ┌───────────────┐             │
             │             │  SNAPSHOT 1   │             │
             │             │               │             │
             │             └───────────────┘             │
             │                                           │
             ▼                                           ▼
     ┌───────────────┐                           ┌───────────────┐
     │   BLOCK 1     │                           │   BLOCK 2     │
     │ (cloud.txt)   │                           │(warehouse.txt)│
     └───────────────┘                           └───────────────┘
```

## 写入工作原理

向表中添加数据时，Fuse Engine 会创建对象链：

### 步骤 1：创建表

```sql
CREATE TABLE git(file VARCHAR, content VARCHAR);
```

此时表无数据：
```
(空表)
```

### 步骤 2：插入第一条数据

```sql
INSERT INTO git VALUES('cloud.txt', '2022/05/06, Databend, Cloud');
```

首次插入后创建初始快照、段和块：
```
         Table HEAD
             │
             ▼
     ┌───────────────┐
     │  SNAPSHOT 1   │
     │               │
     └───────┬───────┘
             │
             ▼
     ┌───────────────┐
     │  SEGMENT A    │
     │               │
     └───────┬───────┘
             │
             ▼
     ┌───────────────┐
     │   BLOCK 1     │
     │ (cloud.txt)   │
     └───────────────┘
```

### 步骤 3：插入更多数据

```sql
INSERT INTO git VALUES('warehouse.txt', '2022/05/07, Databend, Warehouse');
```

插入新数据时创建引用原始段和新段的新快照：
```
                         Table HEAD
                             │
                             ▼
     ┌───────────────┐     ┌───────────────┐     ┌───────────────┐
     │  SEGMENT A    │◄────│  SNAPSHOT 2   │────►│  SEGMENT B    │
     │               │     │ Previous:     │     │               │
     └───────┬───────┘     │ SNAPSHOT 1    │     └───────┬───────┘
             │             └───────────────┘             │
             │                     │                     │
             │                     ▼                     │
             │             ┌───────────────┐             │
             │             │  SNAPSHOT 1   │             │
             │             │               │             │
             │             └───────────────┘             │
             │                                           │
             ▼                                           ▼
     ┌───────────────┐                           ┌───────────────┐
     │   BLOCK 1     │                           │   BLOCK 2     │
     │ (cloud.txt)   │                           │(warehouse.txt)│
     └───────────────┘                           └───────────────┘
```

## 读取工作原理

查询数据时，Fuse Engine 使用智能剪枝高效定位数据：
```
查询：SELECT * FROM git WHERE file = 'cloud.txt';

                         Table HEAD
                             │
                             ▼
     ┌───────────────┐     ┌───────────────┐     ┌───────────────┐
     │  SEGMENT A    │◄────│  SNAPSHOT 2   │────►│  SEGMENT B    │
     │    CHECK      │     │               │     │    CHECK      │
     └───────┬───────┘     └───────────────┘     └───────────────┘
             │                                          ✗
             │                                    (跳过 - 不包含
             │                                     'cloud.txt')
             ▼
     ┌───────────────┐
     │   BLOCK 1     │
     │    CHECK      │
     └───────┬───────┘
             │
             │ ✓ (包含 'cloud.txt')
             ▼
        读取此块
```

### 智能剪枝过程

```
┌─────────────────────────────────────────┐
│ 查询：WHERE file = 'cloud.txt'          │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│ 检查 SEGMENT A                          │
│ 最小文件值：'cloud.txt'                 │
│ 最大文件值：'cloud.txt'                 │
│                                         │
│ 结果：✓ 可能包含目标数据                │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│ 检查 SEGMENT B                          │
│ 最小文件值：'warehouse.txt'             │
│ 最大文件值：'warehouse.txt'             │
│                                         │
│ 结果：✗ 不包含目标数据                  │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│ 检查 SEGMENT A 中的 BLOCK 1             │
│ 最小文件值：'cloud.txt'                 │
│ 最大文件值：'cloud.txt'                 │
│                                         │
│ 结果：✓ 包含目标数据                    │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│ 仅读取 BLOCK 1                          │
└─────────────────────────────────────────┘
```

## 基于快照的功能

Fuse Engine 的快照架构支持强大数据管理能力：

### 时间回溯

查询任意时间点的数据状态。支持数据分支、标记和治理，提供完整审计跟踪和错误恢复。

### 零拷贝模式演进

修改表结构（添加/删除列、重命名、更改类型）**无需重写底层数据文件**：
- 变更记录在新快照的元数据中
- 操作即时完成，无需停机且避免数据迁移
- 旧数据仍可通过原始模式访问

## 高级索引加速查询（Fuse Engine）

除基础块/段剪枝外，Fuse Engine 提供专用二级索引加速特定查询：

| 索引类型          | 描述                                         | 加速场景                         | 示例查询                   |
| :---------------- | :------------------------------------------- | :------------------------------- | :------------------------- |
| **聚合索引**      | 预计算指定分组的聚合结果                     | `COUNT`/`SUM`/`AVG` + `GROUP BY` | `SELECT COUNT(*)... GROUP BY city` |
| **全文索引**      | 支持文本关键词搜索的倒排索引                 | `MATCH` 文本搜索                 | `WHERE MATCH(log_entry, 'error')` |
| **JSON 索引**     | 索引 JSON 文档的特定路径/键                  | JSON 路径/值过滤                 | `WHERE event_data:user.id = 123` |
| **布隆过滤器索引**| 概率性检查快速跳过非匹配块                   | 点查找 (`=`) 和 `IN` 列表过滤    | `WHERE user_id = 'xyz'` |

## 对比：Databend Fuse Engine vs. Apache Iceberg

_**注意**：此对比聚焦**表格式特性**。作为 Databend 原生表格式，Fuse 持续演进以提升**可用性与性能**。功能基于当前版本，后续可能变更。_

| 特性                | Apache Iceberg                     | Databend Fuse Engine               |
| :------------------ | :--------------------------------- | :--------------------------------- |
| **元数据结构**      | 清单列表 → 清单文件 → 数据文件     | **快照** → 段 → 块                 |
| **统计层级**        | 文件级（+分区）                    | **多层级**（快照/段/块）→ 精细剪枝 |
| **剪枝能力**        | 良好（文件/分区统计）              | **优秀**（多级统计+二级索引）      |
| **模式演进**        | 支持（元数据变更）                 | **零拷贝**（纯元数据/即时生效）   |
| **数据聚簇**        | 写入时排序                         | **自动优化**（后台执行）           |
| **流支持**          | 基础流式摄取                       | **高级增量**（插入/更新跟踪）      |