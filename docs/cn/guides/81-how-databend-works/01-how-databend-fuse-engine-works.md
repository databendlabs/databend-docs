---
title: Fuse 引擎工作原理
---

## Fuse 引擎

Fuse 引擎是 Databend 的核心存储引擎，专为在**云对象存储**上高效管理 **PB 级**数据而优化。默认情况下，在 Databend 中创建的表会自动使用此引擎（`ENGINE=FUSE`）。受 Git 启发，其基于快照的设计支持强大的数据版本控制（如时间旅行），并通过先进的剪枝和索引技术提供**高查询性能**。

本文档阐述其核心概念与工作原理。

## 核心概念

Fuse 引擎采用类 Git 的三层结构组织数据：

*   **快照（Snapshot）**：不可变引用，通过指向特定段（Segment）定义表在时间点的状态，支持时间旅行。
*   **段（Segment）**：块（Block）的集合，包含用于快速数据跳过（剪枝）的汇总统计，支持跨快照共享。
*   **块（Block）**：Parquet 格式的不可变数据文件，存储实际行数据及列级统计，实现细粒度剪枝。

```
                         表头
                             │
                             ▼
     ┌───────────────┐     ┌───────────────┐     ┌───────────────┐
     │     段 A      │◄────│    快照 2     │────►│     段 B      │
     │               │     │ 前一个:       │     │               │
     └───────┬───────┘     │    快照 1     │     └───────┬───────┘
             │             └───────────────┘             │
             │                     │                     │
             │                     ▼                     │
             │             ┌───────────────┐             │
             │             │    快照 1     │             │
             │             │               │             │
             │             └───────────────┘             │
             │                                           │
             ▼                                           ▼
     ┌───────────────┐                           ┌───────────────┐
     │     块 1      │                           │     块 2      │
     │ (cloud.txt)   │                           │(warehouse.txt)│
     └───────────────┘                           └───────────────┘
```

## 写入工作原理

向表添加数据时，Fuse 引擎构建对象链，过程如下：

### 步骤 1：创建表

```sql
CREATE TABLE git(file VARCHAR, content VARCHAR);
```

此时表结构为空：

```
（空表）
```

### 步骤 2：插入首条数据

```sql
INSERT INTO git VALUES('cloud.txt', '2022/05/06, Databend, Cloud');
```

首次插入后生成初始快照、段和块：

```
          表头
             │
             ▼
     ┌───────────────┐
     │    快照 1     │
     │               │
     └───────┬───────┘
             │
             ▼
     ┌───────────────┐
     │     段 A      │
     │               │
     └───────┬───────┘
             │
             ▼
     ┌───────────────┐
     │     块 1      │
     │ (cloud.txt)   │
     └───────────────┘
```

### 步骤 3：插入更多数据

```sql
INSERT INTO git VALUES('warehouse.txt', '2022/05/07, Databend, Warehouse');
```

新增数据时创建引用原始段和新段的新快照：

```
                         表头
                             │
                             ▼
     ┌───────────────┐     ┌───────────────┐     ┌───────────────┐
     │     段 A      │◄────│    快照 2     │────►│     段 B      │
     │               │     │ 前一个:       │     │               │
     └───────┬───────┘     │    快照 1     │     └───────┬───────┘
             │             └───────────────┘             │
             │                     │                     │
             │                     ▼                     │
             │             ┌───────────────┐             │
             │             │    快照 1     │             │
             │             │               │             │
             │             └───────────────┘             │
             │                                           │
             ▼                                           ▼
     ┌───────────────┐                           ┌───────────────┐
     │     块 1      │                           │     块 2      │
     │ (cloud.txt)   │                           │(warehouse.txt)│
     └───────────────┘                           └───────────────┘
```

## 读取工作原理

查询时通过智能剪枝高效定位数据：

```
查询: SELECT * FROM git WHERE file = 'cloud.txt';

                         表头
                             │
                             ▼
     ┌───────────────┐     ┌───────────────┐     ┌───────────────┐
     │     段 A      │◄────│    快照 2     │────►│     段 B      │
     │    检查       │     │               │     │    检查       │
     └───────┬───────┘     └───────────────┘     └───────────────┘
             │                                          ✗
             │                                （跳过 - 不含 'cloud.txt'）
             ▼
     ┌───────────────┐
     │     块 1      │
     │    检查       │
     └───────┬───────┘
             │
             │ ✓ （含 'cloud.txt'）
             ▼
        读取该数据块
```

### 智能剪枝过程

```
┌─────────────────────────────────────────┐
│ 查询: WHERE file = 'cloud.txt'          │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│ 检查段 A                                │
│ 最小文件值: 'cloud.txt'                 │
│ 最大文件值: 'cloud.txt'                 │
│                                         │
│ 结果: ✓ 可能包含目标数据                │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│ 检查段 B                                │
│ 最小文件值: 'warehouse.txt'             │
│ 最大文件值: 'warehouse.txt'             │
│                                         │
│ 结果: ✗ 不包含目标数据                  │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│ 检查段 A 中的块 1                       │
│ 最小文件值: 'cloud.txt'                 │
│ 最大文件值: 'cloud.txt'                 │
│                                         │
│ 结果: ✓ 包含目标数据                    │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│ 仅读取块 1                              │
└─────────────────────────────────────────┘
```

## 基于快照的功能

快照架构支持以下数据管理能力：

### 时间旅行

查询历史时间点数据状态，支持数据分支、标记和治理，提供完整审计追踪与错误恢复。

### 零拷贝模式演进

**无需重写数据文件**即可修改表结构（增删列/重命名/改类型）：
- 变更记录为新快照的元数据操作
- 操作瞬时完成，无需停机且避免数据迁移，历史数据仍按原模式访问

## 查询加速的高级索引（Fuse 引擎

除基础剪枝外，还提供专项二级索引加速特定查询：

| 索引类型               | 描述                                         | 加速场景                         | 示例查询                   |
| :--------------------- | :------------------------------------------- | :------------------------------- | :------------------------- |
| **聚合索引**           | 预计算分组聚合结果                           | `COUNT`/`SUM`/`AVG` + `GROUP BY` | `SELECT COUNT(*)... GROUP BY city` |
| **全文索引**           | 文本关键词倒排索引                           | `MATCH` 文本搜索（如日志）       | `WHERE MATCH(log_entry, 'error')` |
| **JSON 索引**          | 索引 JSON 文档路径/键                        | JSON 路径/值过滤                 | `WHERE event_data:user.id = 123` |
| **布隆过滤器索引**     | 概率性跳过非匹配块                           | 点查找（`=`）和 `IN` 过滤        | `WHERE user_id = 'xyz'` |

## 对比：Databend Fuse 引擎 vs. Apache Iceberg

_**注意**：此对比聚焦**表格式特性**。Fuse 作为 Databend 原生格式持续演进以提升**可用性与性能**，下表基于当前版本。_

| 功能                | Apache Iceberg                     | Databend Fuse 引擎               |
| :------------------ | :--------------------------------- | :------------------------------- |
| **元数据结构**      | 清单列表 → 清单文件 → 数据文件     | **快照** → 段 → 块               |
| **统计层级**        | 文件级（含分区）                   | **多级**（快照/段/块）→ 精细剪枝 |
| **剪枝能力**        | 良好（文件/分区统计）              | **优秀**（多级统计 + 二级索引）  |
| **模式演进**        | 支持（元数据变更）                 | **零拷贝**（元数据级，瞬时）     |
| **数据聚簇**        | 写入时排序                         | **自动优化**（后台）             |
| **流式支持**        | 基础流式摄取                       | **高级增量**（插入/更新追踪）    |