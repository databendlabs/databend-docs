---
title: Fuse 引擎工作原理
---

## Fuse 引擎

Fuse 引擎是 Databend 的核心存储引擎，专为在云对象存储上高效管理 PB 级数据而优化。默认情况下，在 Databend 中创建的表会自动使用此引擎（`ENGINE=FUSE`）。其设计灵感来源于 Git，基于快照的架构支持强大的数据版本控制功能（如 Time Travel），并通过先进的剪枝和索引技术提供卓越的查询性能。

本文档将详细介绍其核心概念和工作原理。

## 核心概念

Fuse 引擎采用类似 Git 的三层数据结构：

*   **快照（Snapshot）**：类似 Git 的提交记录，是不可变引用，通过指向特定 Segment 来记录表在某个时间点的状态，支持 Time Travel 功能
*   **段（Segment）**：类似 Git 的树结构，是 Block 的集合，包含用于快速数据跳过（剪枝）的汇总统计信息，可在不同快照间共享
*   **块（Block）**：类似 Git 的数据对象，是不可变的 Parquet 格式数据文件，存储实际行数据和详细的列级统计信息，支持细粒度剪枝

```
                         Table HEAD
                             │
                             ▼
     ┌───────────────┐     ┌───────────────┐     ┌───────────────┐
     │  SEGMENT A    │◄────│  SNAPSHOT 2   │────►│  SEGMENT B    │
     │               │     │ Previous:     │     │               │
     └───────┬───────┘     │ SNAPSHOT 1    │     └───────┬───────┘
             │             └───────────────┘             │
             │                     │                     │
             │                     ▼                     │
             │             ┌───────────────┐             │
             │             │  SNAPSHOT 1   │             │
             │             │               │             │
             │             └───────────────┘             │
             │                                           │
             ▼                                           ▼
     ┌───────────────┐                           ┌───────────────┐
     │   BLOCK 1     │                           │   BLOCK 2     │
     │ (cloud.txt)   │                           │(warehouse.txt)│
     └───────────────┘                           └───────────────┘
```

## 写入流程

向表中添加数据时，Fuse 引擎会构建以下对象链：

### 步骤 1：创建表

```sql
CREATE TABLE git(file VARCHAR, content VARCHAR);
```

此时表结构已创建但无数据：

```
(空表)
```

### 步骤 2：首次插入数据

```sql
INSERT INTO git VALUES('cloud.txt', '2022/05/06, Databend, Cloud');
```

首次插入后会生成初始快照、段和数据块：

```
         Table HEAD
             │
             ▼
     ┌───────────────┐
     │  SNAPSHOT 1   │
     │               │
     └───────┬───────┘
             │
             ▼
     ┌───────────────┐
     │  SEGMENT A    │
     │               │
     └───────┬───────┘
             │
             ▼
     ┌───────────────┐
     │   BLOCK 1     │
     │ (cloud.txt)   │
     └───────────────┘
```

### 步骤 3：追加数据

```sql
INSERT INTO git VALUES('warehouse.txt', '2022/05/07, Databend, Warehouse');
```

新增数据会创建新快照，同时引用原有段和新段：

```
                         Table HEAD
                             │
                             ▼
     ┌───────────────┐     ┌───────────────┐     ┌───────────────┐
     │  SEGMENT A    │◄────│  SNAPSHOT 2   │────►│  SEGMENT B    │
     │               │     │ Previous:     │     │               │
     └───────┬───────┘     │ SNAPSHOT 1    │     └───────┬───────┘
             │             └───────────────┘             │
             │                     │                     │
             │                     ▼                     │
             │             ┌───────────────┐             │
             │             │  SNAPSHOT 1   │             │
             │             │               │             │
             │             └───────────────┘             │
             │                                           │
             ▼                                           ▼
     ┌───────────────┐                           ┌───────────────┐
     │   BLOCK 1     │                           │   BLOCK 2     │
     │ (cloud.txt)   │                           │(warehouse.txt)│
     └───────────────┘                           └───────────────┘
```

## 读取流程

查询时，Fuse 引擎通过智能剪枝高效定位数据：

```
Query: SELECT * FROM git WHERE file = 'cloud.txt';

                         Table HEAD
                             │
                             ▼
     ┌───────────────┐     ┌───────────────┐     ┌───────────────┐
     │  SEGMENT A    │◄────│  SNAPSHOT 2   │────►│  SEGMENT B    │
     │    CHECK      │     │               │     │    CHECK      │
     └───────┬───────┘     └───────────────┘     └───────────────┘
             │                                          ✗
             │                                    (跳过 - 不包含
             │                                     'cloud.txt')
             ▼
     ┌───────────────┐
     │   BLOCK 1     │
     │    CHECK      │
     └───────┬───────┘
             │
             │ ✓ (包含 'cloud.txt')
             ▼
        Read this block
```

### 剪枝过程详解

```
┌─────────────────────────────────────────┐
│ 查询条件: WHERE file = 'cloud.txt'      │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│ 检查 SEGMENT A                          │
│ 最小文件值: 'cloud.txt'                 │
│ 最大文件值: 'cloud.txt'                 │
│                                         │
│ 结果: ✓ 可能包含目标数据                │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│ 检查 SEGMENT B                          │
│ 最小文件值: 'warehouse.txt'             │
│ 最大文件值: 'warehouse.txt'             │
│                                         │
│ 结果: ✗ 排除该段                        │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│ 检查 SEGMENT A 中的 BLOCK 1             │
│ 最小文件值: 'cloud.txt'                 │
│ 最大文件值: 'cloud.txt'                 │
│                                         │
│ 结果: ✓ 确认为目标数据                  │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│ 仅读取 BLOCK 1                          │
└─────────────────────────────────────────┘
```

## 核心特性

Fuse 引擎的快照架构支持以下高级功能：

### Time Travel

查询历史任意时间点的数据状态，支持数据分支、标记和完整审计追踪，便于错误恢复。

### 零拷贝 Schema 变更

支持以下元数据操作而无需重写数据文件：
- 增删改列
- 列重命名
- 类型修改

变更即时生效且无停机时间，历史数据仍按原始 Schema 可访问。

## 查询加速索引

除基础统计剪枝外，还提供以下专用索引：

| 索引类型          | 描述                           | 适用场景                | 示例                     |
|-------------------|--------------------------------|-------------------------|--------------------------|
| **聚合索引**      | 预计算分组聚合结果             | GROUP BY 聚合查询       | `SELECT COUNT(*)... GROUP BY city` |
| **全文索引**      | 文本关键词倒排索引             | 日志分析等文本搜索      | `WHERE MATCH(log_entry, 'error')` |
| **JSON 索引**     | 索引 JSON 文档特定路径         | JSON 字段过滤           | `WHERE event_data:user.id = 123` |
| **布隆过滤器**    | 快速排除不匹配块               | 等值查询和 IN 列表      | `WHERE user_id = 'xyz'` |

## 技术对比：Fuse vs Iceberg

_注：本对比聚焦表格式特性，Fuse 作为 Databend 原生格式持续演进_

| 特性              | Apache Iceberg                 | Databend Fuse                |
|-------------------|--------------------------------|------------------------------|
| **元数据结构**    | 清单列表→清单文件→数据文件     | 快照→段→块                   |
| **统计粒度**      | 文件级+分区                    | 快照/段/块多级统计           |
| **剪枝效率**      | 良好                          | 优秀（多级统计+二级索引）    |
| **Schema 变更**   | 支持                          | 零拷贝即时生效               |
| **数据组织**      | 写入时排序                    | 后台自动优化                 |
| **流式支持**      | 基础摄取                      | 高级增量跟踪                 |