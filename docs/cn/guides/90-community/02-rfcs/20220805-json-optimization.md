---
title: JSON ä¼˜åŒ–
description: Databend æŸ¥è¯¢çš„ JSON ä¼˜åŒ–
---

- RFC PR: [datafuselabs/databend#6995](https://github.com/datafuselabs/databend/pull/6995)
- è·Ÿè¸ªé—®é¢˜: [datafuselabs/databend#6994](https://github.com/datafuselabs/databend/issues/6994)

## æ‘˜è¦

æœ¬ RFC æè¿°äº† JSON æ€§èƒ½ä¼˜åŒ–çš„è®¾è®¡ã€‚

## åŠ¨æœº

ç›®å‰ï¼ŒDatabend åŠç»“æž„åŒ–æ•°æ®ä»¥åŽŸå§‹æ–‡æœ¬ JSON æ ¼å¼å­˜å‚¨ï¼Œå¹¶ä½¿ç”¨ `serde_json` è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚
å®ƒå­˜åœ¨ä»¥ä¸‹æ€§èƒ½é—®é¢˜ï¼š

1. æ¯æ¬¡ä½¿ç”¨ JSON æ—¶éƒ½å¿…é¡»è¿›è¡Œè§£æžï¼Œæ–‡æœ¬è§£æžéžå¸¸æ…¢ï¼Œå°¤å…¶æ˜¯å¯¹äºŽå¤§åž‹å¤æ‚å¯¹è±¡æ•°æ®ã€‚
2. æŸ¥è¯¢å•ä¸ªé”®è·¯å¾„éœ€è¦è¯»å–å’Œè§£æžæ•´ä¸ª JSON æ•°æ®ï¼Œè¿™ä¼šå ç”¨æ›´å¤šçš„è§£æžæ—¶é—´å’Œå†…å­˜ã€‚

ä¸ºäº†ä½¿åŠç»“æž„åŒ–æ•°æ®çš„æŸ¥è¯¢æ€§èƒ½ä¸Žå…¶ä»–æ•°æ®ç±»åž‹ä¸€æ ·å¿«ã€‚æœ¬ RFC æå‡ºäº†ä»¥ä¸‹ä¸¤ä¸ªæè®®ï¼š

- è‡ªåŠ¨æ£€æµ‹ JSON åˆ—ä¸­é¢‘ç¹æŸ¥è¯¢çš„é”®è·¯å¾„ï¼Œå¹¶å°†å®ƒä»¬æå–ä¸ºè™šæ‹Ÿåˆ—ï¼Œä»¥å®žçŽ°ä¸Žå…¶ä»–åˆ—ç±»ä¼¼çš„æŸ¥è¯¢æ€§èƒ½ã€‚
- ä½¿ç”¨ JSONB è€Œä¸æ˜¯ JSON ä½œä¸ºåŠç»“æž„åŒ–æ•°æ®ç±»åž‹çš„åº•å±‚äºŒè¿›åˆ¶ç¼–ç æ ¼å¼ï¼Œè¿™å°†ä¼˜åŒ–è§£æžé€Ÿåº¦å¹¶æœ‰åˆ©äºŽé”®è·¯å¾„è®¿é—®ã€‚

## æŒ‡å—çº§è¯´æ˜Ž

æ— ã€‚

## å‚è€ƒçº§è¯´æ˜Ž

### è™šæ‹Ÿåˆ—

JSON çš„æ¨¡å¼å¯ä»¥ä»»æ„æ›´æ”¹ã€‚ç„¶è€Œï¼Œåœ¨å®žé™…ä½¿ç”¨ä¸­ï¼ŒJSON æ•°æ®é€šå¸¸ç”±æœºå™¨ç”Ÿæˆï¼Œå¹¶å…·æœ‰ç›¸å½“ä¸¥æ ¼å’Œå¯é¢„æµ‹çš„ç»“æž„ã€‚
åˆ©ç”¨è¿™ä¸€ç‰¹ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥æ£€æµ‹å¹¶æå– JSON çš„é¢‘ç¹æŸ¥è¯¢é”®è·¯å¾„ä½œä¸ºè™šæ‹Ÿåˆ—ï¼Œä»¥åŠ é€ŸæŸ¥è¯¢å¤„ç†ã€‚

#### æ”¶é›†é¢‘ç¹è®¿é—®çš„ JSON é”®è·¯å¾„

æå–å’Œå­˜å‚¨è™šæ‹Ÿåˆ—éœ€è¦é¢å¤–çš„è§£æžè¿‡ç¨‹å’Œå­˜å‚¨èµ„æºï¼Œå› æ­¤ä¸ºæ‰€æœ‰é”®è·¯å¾„ç”Ÿæˆè™šæ‹Ÿåˆ—æ˜¯ä¸åˆé€‚çš„ã€‚
æˆ‘ä»¬åº”è¯¥åªä¸ºé¢‘ç¹æŸ¥è¯¢çš„ JSON é”®è·¯å¾„ç”Ÿæˆè™šæ‹Ÿåˆ—ã€‚

ä¸ºäº†çŸ¥é“å“ªäº›é”®è·¯å¾„è¢«é¢‘ç¹æŸ¥è¯¢ï¼Œ
æˆ‘ä»¬ä½¿ç”¨ [FPGrowth ç®—æ³•](https://link.springer.com/content/pdf/10.1023/B:DAMI.0000005258.31418.83.pdf) æ¥è®¡ç®— JSON æ•°æ®é”®è·¯å¾„çš„è®¿é—®é¢‘çŽ‡ã€‚
â€œFPâ€ä»£è¡¨é¢‘ç¹æ¨¡å¼ï¼Œé€šå¸¸ç”¨äºŽè®¡ç®—é¡¹ç›®é¢‘çŽ‡å’Œè¯†åˆ«é¢‘ç¹é¡¹ã€‚
æ¯æ¬¡ç”¨æˆ·æŸ¥è¯¢ JSON æ•°æ®çš„ä¸€ä¸ªé”®è·¯å¾„æ—¶ï¼Œéƒ½ä¼šè¢« FPGrowth ç®—æ³•è®°å½•ä¸‹æ¥ï¼Œæœ€ç»ˆç”Ÿæˆä¸€æ£µæ ‘çŠ¶çš„ç»Ÿè®¡ä¿¡æ¯ã€‚
æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™ä¸ªç»Ÿè®¡ä¿¡æ¯æ¥ç¡®å®šå“ªäº›é”®è·¯å¾„éœ€è¦ç”Ÿæˆè™šæ‹Ÿåˆ—ã€‚

#### æå–è™šæ‹Ÿåˆ—

æå–è™šæ‹Ÿåˆ—çš„æ“ä½œæ˜¯å¼‚æ­¥è¿›è¡Œçš„ï¼Œå› æ­¤ä¸ä¼šå½±å“æ•°æ®æ’å…¥çš„æ€§èƒ½ã€‚
ç”±äºŽ Databend ä¼šå®šæœŸåŽ‹ç¼©è¡¨å—ï¼Œæˆ‘ä»¬å¯ä»¥å°†æå–è™šæ‹Ÿåˆ—ä½œä¸ºé¢å¤–æ“ä½œè¿›è¡Œï¼Œå¦‚æžœåˆ—æ•°æ®ç±»åž‹æ˜¯ JSONã€‚
è¿™æ ·ï¼Œå·²ç»è¯»å–ç”¨äºŽåŽ‹ç¼©çš„æ•°æ®å¯ä»¥è¢«é‡ç”¨ï¼Œè¿™å°†å‡å°‘ä¸å¿…è¦çš„è¯»æ”¾å¤§ã€‚

æå–è™šæ‹Ÿåˆ—çš„è¿‡ç¨‹å¦‚ä¸‹ï¼š

1. æ”¶é›†è®¿é—®è®¡æ•°è¶…è¿‡ FPGrowth ç®—æ³•ç”Ÿæˆçš„é˜ˆå€¼çš„é”®è·¯å¾„ã€‚
2. è§£æž JSON æ•°æ®ï¼ŒæŽ¨æ–­æ‰€æœ‰é”®è·¯å¾„çš„ JSON æ¨¡å¼ï¼ŒåŒ…æ‹¬å€¼çš„æ•°æ®ç±»åž‹å’Œè¡Œå·ã€‚
3. æ£€æŸ¥æ‰€æœ‰é”®è·¯å¾„ï¼Œå¦‚æžœå€¼çš„æ•°æ®ç±»åž‹ç›¸åŒï¼Œå¹¶ä¸”æ¯è¡Œéƒ½æœ‰æ•°æ®ï¼Œä»Žè¿™ä¸ªé”®è·¯å¾„æå–æ•°æ®ç”Ÿæˆè™šæ‹Ÿåˆ—ï¼Œå¹¶å°†å®ƒä»¬å­˜å‚¨åœ¨å•ç‹¬çš„ parquet æ–‡ä»¶ä¸­ã€‚

ä»¥ä»¥ä¸‹ JSON ä¸ºä¾‹ã€‚

```json
{"id":1,"title":"a","user":{"id":1,"name":"a"},"tags":["t1","t2"]}
{"id":2,"title":"b","user":{"id":2,"name":"b"},"tags":["t3","t4"]}
{"id":3,"title":"c","user":{"id":3,"name":3}}
{"id":4,"title":"d","user":{"id":4,"name":4}}
```

é”®è·¯å¾„ `id`ã€`title` å’Œ `user:id` å…·æœ‰ç›¸åŒçš„æ•°æ®ç±»åž‹ï¼Œæˆ‘ä»¬å¯ä»¥å°†å®ƒä»¬æå–ä¸ºè™šæ‹Ÿåˆ—ã€‚
å¯¹äºŽ `user.name`ï¼Œæ•°æ®ç±»åž‹çš„å€¼ä¸åŒã€‚
å¯¹äºŽ `tags`ï¼Œå®ƒä¸åœ¨æ¯ä¸€è¡Œä¸Šã€‚æˆ‘ä»¬ä¸ä¸ºå®ƒä»¬ç”Ÿæˆè™šæ‹Ÿåˆ—ã€‚

#### å°†é”®è·¯å¾„è®¿é—®ä¸‹æŽ¨åˆ°å­˜å‚¨

è®¿é—® json é”®è·¯å¾„æœ‰ä¸¤ç§æ–¹å¼ï¼šç‚¹è¡¨ç¤ºæ³•ï¼Œå¦‚ `col:level1:level2` å’Œæ‹¬å·è¡¨ç¤ºæ³•ï¼Œå¦‚ `col['level1'][0]`ã€‚

ä¾‹å¦‚ï¼š

```sql
create table test (id int8, v json);
insert into test values(1, parse_json('{"k1":{"k2":"v"},"a":[0,1,2]}'));
select v:k1:k2, v['a'][0] from test;
+---------+-----------+
| v:k1:k2 | v['a'][0] |
+---------+-----------+
| "v"     | 0         |
+---------+-----------+
```

ç›®å‰ï¼ŒJSON é”®è·¯å¾„çš„è®¿é—®å°†è¢«è½¬æ¢ä¸º `get` æ ‡é‡å‡½æ•°ï¼Œå¹¶é€šè¿‡é”®éåŽ† JSON ä»¥èŽ·å–å€¼ã€‚
ä¸ºäº†ä½¿ç”¨è™šæ‹Ÿåˆ—æé«˜æ€§èƒ½ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹æŸ¥è¯¢è®¡åˆ’å¹¶å°†é”®è·¯å¾„è®¿é—®ä¸‹æŽ¨åˆ°å­˜å‚¨å±‚ã€‚
ç”±äºŽæˆ‘ä»¬ä½¿ç”¨ JSONB è€Œä¸æ˜¯ JSONï¼Œå³ä½¿å¯¹äºŽæ²¡æœ‰ç”Ÿæˆè™šæ‹Ÿåˆ—çš„é”®è·¯å¾„ï¼Œä¸‹æŽ¨åˆ°å­˜å‚¨å±‚ä¹Ÿä¼šå¸¦æ¥å¥½å¤„ã€‚

### JSONB

JSONB ä»£è¡¨ `JSON Binary` æˆ– `JSON better`ï¼Œè¿™æ˜¯ PostgreSQL ä»Ž v9.4 å¼€å§‹æ”¯æŒçš„ä¸€ç§ä¼˜åŒ–çš„äºŒè¿›åˆ¶æ ¼å¼æ•°æ®ç±»åž‹ã€‚
CockroachDB ä¹ŸåŸºäºŽ PostgreSQL è®¾è®¡å®žçŽ°äº† JSONBã€‚

é€šè¿‡å°†æ•°æ®å­˜å‚¨ä¸º JSONB è€Œä¸æ˜¯ JSONï¼Œæˆ‘ä»¬å¯ä»¥èŽ·å¾—ä»¥ä¸‹å¥½å¤„ï¼š

- JSONB çš„è§£æžå’ŒæŸ¥è¯¢è¿‡ç¨‹æ˜Žæ˜¾æ›´å¿«ã€‚
- è®¿é—®ç‰¹å®šé”®è·¯å¾„ä¸éœ€è¦è¯»å–å®Œæ•´æ•°æ®ï¼Œè¿™å°†å¤§å¤§æé«˜æ•´ä½“æ€§èƒ½ã€‚
- å¯ä»¥æ·»åŠ å¤–éƒ¨ç´¢å¼•ä»¥è¿›ä¸€æ­¥åŠ é€ŸæŸ¥è¯¢ã€‚

#### äºŒè¿›åˆ¶ç¼–ç 

JSONB æ˜¯ä¸€ç§æ ‘ç»“æž„ã€‚æ¯ä¸ªèŠ‚ç‚¹ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼Œä¸€ä¸ª 32 ä½çš„å¤´éƒ¨ï¼Œå‡ ä¸ª 32 ä½çš„ `JEntry`ï¼Œä»¥åŠå¯å˜é•¿åº¦çš„åŽŸå§‹å†…å®¹ã€‚

- å¤´éƒ¨ä¹Ÿç§°ä¸ºå®¹å™¨å¤´éƒ¨ï¼Œå®ƒåŒ…æ‹¬ä¸€ä¸ª 3 ä½çš„ç±»åž‹ï¼ˆåŒ…æ‹¬ `array`ã€`object` å’Œ `scalar`ï¼‰å’Œä¸€ä¸ª 28 ä½çš„æ•°å­—ï¼Œç”¨äºŽæŒ‡ç¤º `array` æˆ– `object` ä¸­çš„å…ƒç´ æ•°é‡ã€‚
- `JEntry` æœ‰ä¸€ä¸ª 3 ä½çš„å€¼ç±»åž‹ï¼ˆåŒ…æ‹¬ `true`ã€`false`ã€`null`ã€`string`ã€`number`ã€`array` å’Œ `object`ï¼‰ï¼Œä¸€ä¸ª 28 ä½æä¾›åŽŸå§‹å†…å®¹çš„é•¿åº¦æˆ–åç§»é‡ï¼Œä»¥åŠä¸€ä¸ª 1 ä½æ ‡å¿—ï¼Œç”¨äºŽæŒ‡ç¤ºä½¿ç”¨é•¿åº¦è¿˜æ˜¯åç§»é‡ã€‚
- æœ€åŽä¸€éƒ¨åˆ†æ˜¯åŽŸå§‹å†…å®¹å€¼ï¼Œå¯ä»¥é€šè¿‡ `JEntry` ä¸­çš„é•¿åº¦æˆ–åç§»é‡å®šä½ã€‚

ä»¥æ­¤ JSON ä¸ºä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° JSONB çš„ç¼–ç æ ¼å¼å¦‚ä¸‹ã€‚

```json
{ "a": 1, "b": [true, 2, "v"] }
```

```
  .--------------.    .-----------------------------------.
  |    header    | -> |    type(object) | item nums(2)    |
  .--------------.    .-----------------------------------.
  | key1 JEntry  | -> | flag | val type(string) | len/off | -+
  .--------------.    .-----------------------------------.  |
  | key2 JEntry  | -> | flag | val type(string) | len/off | -+-+
  .--------------.    .-----------------------------------.  | |
  | val1 JEntry  | -> | flag | val type(number) | len/off | -+-+-+
  .--------------.    .-----------------------------------.  | | |
  | val2 JEntry  | -> | flag | val type(string) | len/off | -+-+-+-+
  .--------------.    .-----------------------------------.  | | | |
  |     "a"      | <-----------------------------------------+ | | |
  .--------------.                                             | | |
  |     "b"      | <-------------------------------------------+ | |
  .--------------.                                               | |
  |      1       | <---------------------------------------------+ |
  .--------------.                                                 |
  | [true,2,"v"] | <-----------------------------------------------+
  .--------------.
        |           .--------------+    .-----------------------------------.
        +---------> |    header    | -> |    type(array) | item nums(3)     |
                    .--------------+    .-----------------------------------.
                    | item1 JEntry | -> | flag | val type(bool true)        |
                    .--------------+    .-----------------------------------.
                    | item2 JEntry | -> | flag | val type(number) | len/off | -+
                    .--------------+    .-----------------------------------.  |
                    | item3 JEntry | -> | flag | val type(string) | len/off | -+-+
                    .--------------+    .-----------------------------------.  | |
                    |      2       | <-----------------------------------------+ |
                    .--------------.                                             |
                    |     "v"      | <-------------------------------------------+
                    .--------------.

æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§ [PostgreSQL](https://github.com/postgres/postgres/blob/master/src/include/utils/jsonb.h)
å’Œ [CockroachDB](https://github.com/cockroachdb/cockroach/blob/master/docs/RFCS/20171005_jsonb_encoding.md) çš„è®¾è®¡

å¾—ç›ŠäºŽ JSONB çš„æ ‘çŠ¶ç»“æž„ï¼Œæœç´¢é”®è·¯å¾„åªéœ€è¦è§£æžå®Œæ•´æ•°æ®çš„ä¸€éƒ¨åˆ†ã€‚
åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸­ï¼Œå¯¹è±¡é”®å¯ä»¥åœ¨ O(ð‘™ð‘œð‘”(ð‘›)) æ—¶é—´å†…è¢«è®¿é—®ï¼Œå› ä¸ºé”®æ˜¯æŽ’åºçš„å¹¶ä¸”å¯ä»¥ä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾ï¼Œè€Œæ•°ç»„å…ƒç´ å¯ä»¥åœ¨ O(1) æ—¶é—´å†…è¢«è®¿é—®ï¼Œå› ä¸º JEntry çš„é•¿åº¦æ˜¯å›ºå®šçš„ã€‚

## ç¼ºç‚¹

- æå–è™šæ‹Ÿåˆ—éœ€è¦é¢å¤–çš„å¼‚æ­¥ä»»åŠ¡ã€‚
- JSONB å¯èƒ½ä¼šå ç”¨æ¯” JSON æ›´å¤šçš„ç£ç›˜ç©ºé—´ã€‚

## åŽŸç†å’Œæ›¿ä»£æ–¹æ¡ˆ

[BSON](http://bsonspec.org) æ˜¯ MongoDB ä½¿ç”¨çš„ä¸€ç§äºŒè¿›åˆ¶ JSON æ ¼å¼ã€‚
å…¶ä¸»è¦è®¾è®¡ç›®æ ‡æ˜¯å­˜å‚¨æ–‡æ¡£ï¼Œå› æ­¤å®ƒåœ¨å¤´éƒ¨æ²¡æœ‰é”®è·¯å¾„çš„ç´¢å¼•ã€‚

[ION](https://amzn.github.io/ion-docs/) ä¹Ÿæ˜¯ç”±äºšé©¬é€Šå¼€å‘çš„ä¸€ç§äºŒè¿›åˆ¶ JSON æ ¼å¼ã€‚
å®ƒé’ˆå¯¹è¯»å–è¿›è¡Œäº†ä¼˜åŒ–ï¼Œå¹¶ä¸”æœ‰ç¬¦å·è¡¨ä½œä¸ºç´¢å¼•ä»¥åŠ é€Ÿé”®è·¯å¾„è®¿é—®ã€‚
å…¶ä¸»è¦é—®é¢˜æ˜¯ Rust ç‰ˆæœ¬çš„å¼€å‘ä»å¤„äºŽæ—©æœŸStageï¼Œç¼ºä¹ä¸€äº›é‡è¦çš„ç‰¹æ€§æ”¯æŒï¼Œå¦‚ `serde`ã€‚

è¿˜æœ‰ä¸€äº›é’ˆå¯¹çº¯æ–‡æœ¬ json çš„ä¼˜åŒ–ï¼Œä¾‹å¦‚
[simd-json](https://github.com/simd-lite/simd-json) ä½¿ç”¨ SIMD æŒ‡ä»¤åŠ é€Ÿè§£æžï¼Œ
[Pison](https://github.com/AutomataLab/Pison) é€šè¿‡æ·»åŠ ä½å›¾ç´¢å¼•åŠ é€Ÿè§£æžã€‚
ä½†å®ƒä»¬é’ˆå¯¹çš„æ˜¯å…¨æ•°æ®è§£æžä¼˜åŒ–ï¼Œè¿™å¹¶ä¸æœ‰åŠ©äºŽé€šè¿‡é”®è·¯å¾„åŠ é€Ÿè®¿é—®ã€‚

## å…ˆè¡ŒæŠ€æœ¯

è¿™ä¸ª RFC çš„ä¸»è¦æ€æƒ³æ¥è‡ªäºŽ [JSON Tiles](https://db.in.tum.de/people/sites/durner/papers/json-tiles-sigmod21.pdf) è®ºæ–‡ã€‚
è®ºæ–‡ä¸­çš„å®žéªŒè¯„ä¼°æ˜¾ç¤ºï¼Œè¿™äº›ä¼˜åŒ–å¯ä»¥æœ‰æ•ˆåœ°æé«˜ JSON æ•°æ®çš„è¯»å–æ€§èƒ½ã€‚

PostgreSQL å’Œ CockroachDB ä½¿ç”¨ JSONB ä½œä¸ºä¼˜åŒ–åŽçš„ JSON æ ¼å¼ï¼Œæˆ‘ä»¬å¯ä»¥åŸºäºŽå®ƒä»¬çš„è®¾è®¡å®žçŽ° Rust ç‰ˆæœ¬çš„ JSONBã€‚

## æœªè§£å†³çš„é—®é¢˜

æ— ã€‚

## æœªæ¥å¯èƒ½æ€§

- ä¸ºå…·æœ‰ä¸åŒæ•°æ®ç±»åž‹å€¼çš„é”®è·¯å¾„æå–è™šæ‹Ÿåˆ—
- ä¸º JSONB æ·»åŠ é¢å¤–ç´¢å¼•
```
