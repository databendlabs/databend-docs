---
title: JSON ä¼˜åŒ–
description: Databend æŸ¥è¯¢çš„ JSON ä¼˜åŒ–
---

- RFC PR: [datafuselabs/databend#6995](https://github.com/databendlabs/databend/pull/6995)
- è·Ÿè¸ªé—®é¢˜: [datafuselabs/databend#6994](https://github.com/databendlabs/databend/issues/6994)

## æ¦‚è¿°

æœ¬ RFC æè¿°äº† JSON æ€§èƒ½ä¼˜åŒ–çš„è®¾è®¡ã€‚

## åŠ¨æœº

ç›®å‰ï¼ŒDatabend åŠç»“æž„åŒ–æ•°æ®ä»¥åŽŸå§‹æ–‡æœ¬ JSON æ ¼å¼å­˜å‚¨ï¼Œå¹¶ä½¿ç”¨ `serde_json` è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚
å®ƒå­˜åœ¨ä»¥ä¸‹æ€§èƒ½é—®é¢˜ï¼š

1. JSON æ¯æ¬¡ä½¿ç”¨æ—¶éƒ½å¿…é¡»è§£æžï¼Œè€Œæ–‡æœ¬è§£æžéžå¸¸æ…¢ï¼Œå°¤å…¶æ˜¯å¯¹äºŽå¤§åž‹å¤æ‚å¯¹è±¡æ•°æ®ã€‚
2. æŸ¥è¯¢å•ä¸ªé”®è·¯å¾„éœ€è¦è¯»å–å’Œè§£æžæ•´ä¸ª JSON æ•°æ®ï¼Œè¿™éœ€è¦æ›´å¤šçš„è§£æžæ—¶é—´å’Œå ç”¨æ›´å¤šçš„å†…å­˜ã€‚

ä¸ºäº†ä½¿åŠç»“æž„åŒ–æ•°æ®çš„æŸ¥è¯¢æ€§èƒ½ä¸Žå…¶ä»–æ•°æ®ç±»åž‹ä¸€æ ·å¿«ã€‚æœ¬ RFC æå‡ºäº†ä»¥ä¸‹ä¸¤ä¸ªå»ºè®®ï¼š

- è‡ªåŠ¨æ£€æµ‹ JSON åˆ—çš„é¢‘ç¹æŸ¥è¯¢é”®è·¯å¾„ï¼Œå¹¶å°†å…¶æå–ä¸ºè™šæ‹Ÿåˆ—ï¼Œä»¥å®žçŽ°ä¸Žå…¶ä»–åˆ—ç±»ä¼¼çš„æŸ¥è¯¢æ€§èƒ½ã€‚
- ä½¿ç”¨ JSONB ä»£æ›¿ JSON ä½œä¸ºåŠç»“æž„åŒ–æ•°æ®ç±»åž‹çš„åº•å±‚äºŒè¿›åˆ¶ç¼–ç æ ¼å¼ï¼Œè¿™å°†ä¼˜åŒ–è§£æžé€Ÿåº¦å¹¶æœ‰åˆ©äºŽé”®è·¯å¾„è®¿é—®ã€‚

## æŒ‡å—çº§è§£é‡Š

æ— ã€‚

## å‚è€ƒçº§è§£é‡Š

### è™šæ‹Ÿåˆ—

JSON çš„æ¨¡å¼å¯ä»¥ä»»æ„æ›´æ”¹ã€‚ç„¶è€Œï¼Œåœ¨å®žé™…ä½¿ç”¨ä¸­ï¼ŒJSON æ•°æ®é€šå¸¸ç”±æœºå™¨ç”Ÿæˆï¼Œå…·æœ‰ç›¸å½“åˆšæ€§å’Œå¯é¢„æµ‹çš„ç»“æž„ã€‚
åˆ©ç”¨è¿™ä¸€ç‰¹æ€§ï¼Œæˆ‘ä»¬å¯ä»¥æ£€æµ‹å¹¶æå–é¢‘ç¹æŸ¥è¯¢çš„ JSON é”®è·¯å¾„ä½œä¸ºè™šæ‹Ÿåˆ—ï¼Œä»¥åŠ å¿«æŸ¥è¯¢å¤„ç†ã€‚

#### æ”¶é›†é¢‘ç¹è®¿é—®çš„ JSON é”®è·¯å¾„

æå–å’Œå­˜å‚¨è™šæ‹Ÿåˆ—éœ€è¦é¢å¤–çš„è§£æžè¿‡ç¨‹å’Œå­˜å‚¨èµ„æºï¼Œå› æ­¤ä¸é€‚åˆä¸ºæ‰€æœ‰é”®è·¯å¾„ç”Ÿæˆè™šæ‹Ÿåˆ—ã€‚
æˆ‘ä»¬åªåº”ä¸ºé¢‘ç¹æŸ¥è¯¢çš„ JSON é”®è·¯å¾„ç”Ÿæˆè™šæ‹Ÿåˆ—ã€‚

ä¸ºäº†çŸ¥é“å“ªäº›é”®è·¯å¾„æ˜¯é¢‘ç¹æŸ¥è¯¢çš„ï¼Œ
æˆ‘ä»¬ä½¿ç”¨ [FPGrowth ç®—æ³•](https://link.springer.com/content/pdf/10.1023/B:DAMI.0000005258.31418.83.pdf) æ¥ç»Ÿè®¡ JSON æ•°æ®é”®è·¯å¾„çš„è®¿é—®é¢‘çŽ‡ã€‚
â€œFPâ€ä»£è¡¨é¢‘ç¹æ¨¡å¼ï¼Œé€šå¸¸ç”¨äºŽè®¡ç®—é¡¹ç›®é¢‘çŽ‡å¹¶è¯†åˆ«é¢‘ç¹é¡¹ç›®ã€‚
æ¯æ¬¡ç”¨æˆ·æŸ¥è¯¢ JSON æ•°æ®çš„ä¸€ä¸ªé”®è·¯å¾„æ—¶ï¼Œå®ƒéƒ½ä¼šè¢« FPGrowth ç®—æ³•è®°å½•ä¸‹æ¥ï¼Œæœ€ç»ˆç”Ÿæˆæ ‘çŠ¶ç»Ÿè®¡ä¿¡æ¯ã€‚
æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™äº›ç»Ÿè®¡ä¿¡æ¯æ¥ç¡®å®šå“ªäº›é”®è·¯å¾„éœ€è¦ç”Ÿæˆè™šæ‹Ÿåˆ—ã€‚

#### æå–è™šæ‹Ÿåˆ—

æå–è™šæ‹Ÿåˆ—çš„æ“ä½œæ˜¯å¼‚æ­¥æ‰§è¡Œçš„ï¼Œå› æ­¤ä¸ä¼šå½±å“æ•°æ®æ’å…¥çš„æ€§èƒ½ã€‚
ç”±äºŽ Databend ä¼šå®šæœŸåŽ‹ç¼©è¡¨å—ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨åˆ—æ•°æ®ç±»åž‹ä¸º JSON æ—¶å°†å…¶ä½œä¸ºé™„åŠ æ“ä½œè¿›è¡Œè™šæ‹Ÿåˆ—æå–ã€‚
è¿™æ ·ï¼Œç”¨äºŽåŽ‹ç¼©çš„æ•°æ®å¯ä»¥é‡å¤ä½¿ç”¨ï¼Œä»Žè€Œå‡å°‘ä¸å¿…è¦çš„è¯»å–æ”¾å¤§ã€‚

æå–è™šæ‹Ÿåˆ—çš„è¿‡ç¨‹å¦‚ä¸‹ï¼š

1. æ”¶é›†ç”± FPGrowth ç®—æ³•ç”Ÿæˆçš„è®¿é—®æ¬¡æ•°è¶…è¿‡é˜ˆå€¼çš„é”®è·¯å¾„ã€‚
2. è§£æž JSON æ•°æ®ï¼ŒæŽ¨æ–­æ‰€æœ‰é”®è·¯å¾„çš„ JSON æ¨¡å¼ï¼ŒåŒ…æ‹¬å€¼çš„æ•°æ®ç±»åž‹å’Œè¡Œæ•°ã€‚
3. æ£€æŸ¥æ‰€æœ‰é”®è·¯å¾„ï¼Œå¦‚æžœå€¼çš„æ•°æ®ç±»åž‹ç›¸åŒï¼Œå¹¶ä¸”æ¯è¡Œéƒ½æœ‰æ•°æ®ï¼Œåˆ™ä»Žè¯¥é”®è·¯å¾„æå–æ•°æ®ä»¥ç”Ÿæˆè™šæ‹Ÿåˆ—ï¼Œå¹¶å°†å…¶å­˜å‚¨åœ¨å•ç‹¬çš„ parquet æ–‡ä»¶ä¸­ã€‚

ä»¥ä»¥ä¸‹ JSON ä¸ºä¾‹ã€‚

```json
{"id":1,"title":"a","user":{"id":1,"name":"a"},"tags":["t1","t2"]}
{"id":2,"title":"b","user":{"id":2,"name":"b"},"tags":["t3","t4"]}
{"id":3,"title":"c","user":{"id":3,"name":3}}
{"id":4,"title":"d","user":{"id":4,"name":4}}
```

é”®è·¯å¾„ `id`ã€`title` å’Œ `user:id` å…·æœ‰ç›¸åŒçš„æ•°æ®ç±»åž‹ï¼Œæˆ‘ä»¬å¯ä»¥å°†å®ƒä»¬æå–ä¸ºè™šæ‹Ÿåˆ—ã€‚
å¯¹äºŽ `user.name`ï¼Œå€¼çš„æ•°æ®ç±»åž‹ä¸åŒã€‚
å¯¹äºŽ `tags`ï¼Œå®ƒä¸åœ¨æ¯ä¸€è¡Œä¸­ã€‚æˆ‘ä»¬ä¸ä¸ºå®ƒä»¬ç”Ÿæˆè™šæ‹Ÿåˆ—ã€‚

#### å°†é”®è·¯å¾„è®¿é—®ä¸‹æŽ¨åˆ°å­˜å‚¨å±‚

è®¿é—® json é”®è·¯å¾„æœ‰ä¸¤ç§æ–¹å¼ï¼šç‚¹è¡¨ç¤ºæ³•å¦‚ `col:level1:level2` å’Œæ‹¬å·è¡¨ç¤ºæ³•å¦‚ `col['level1'][0]`ã€‚

ä¾‹å¦‚ï¼š

```sql
create table test (id int8, v json);
insert into test values(1, parse_json('{"k1":{"k2":"v"},"a":[0,1,2]}'));
select v:k1:k2, v['a'][0] from test;
+---------+-----------+
| v:k1:k2 | v['a'][0] |
+---------+-----------+
| "v"     | 0         |
+---------+-----------+
```

ç›®å‰ï¼ŒJSON é”®è·¯å¾„çš„è®¿é—®å°†è½¬æ¢ä¸º `get` æ ‡é‡å‡½æ•°ï¼Œå¹¶é€šè¿‡é”®éåŽ† JSON ä»¥èŽ·å–å€¼ã€‚
ä¸ºäº†ä½¿ç”¨è™šæ‹Ÿåˆ—æ¥æé«˜æ€§èƒ½ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹æŸ¥è¯¢è®¡åˆ’å¹¶å°†é”®è·¯å¾„è®¿é—®ä¸‹æŽ¨åˆ°å­˜å‚¨å±‚ã€‚
ç”±äºŽæˆ‘ä»¬ä½¿ç”¨ JSONB è€Œä¸æ˜¯ JSONï¼Œå³ä½¿å¯¹äºŽæœªç”Ÿæˆè™šæ‹Ÿåˆ—çš„é”®è·¯å¾„ï¼Œä¸‹æŽ¨åˆ°å­˜å‚¨å±‚ä¹Ÿä¼šå¸¦æ¥å¥½å¤„ã€‚

### JSONB

JSONB ä»£è¡¨ `JSON äºŒè¿›åˆ¶` æˆ– `JSON æ›´å¥½`ï¼Œè¿™æ˜¯è‡ª v9.4 ä»¥æ¥ PostgreSQL æ”¯æŒçš„ä¼˜åŒ–äºŒè¿›åˆ¶æ ¼å¼æ•°æ®ç±»åž‹ã€‚
CockroachDB ä¹ŸåŸºäºŽ PostgreSQL è®¾è®¡å®žçŽ°äº† JSONBã€‚

é€šè¿‡å°†æ•°æ®å­˜å‚¨ä¸º JSONB è€Œä¸æ˜¯ JSONï¼Œæˆ‘ä»¬å¯ä»¥èŽ·å¾—ä»¥ä¸‹å¥½å¤„ï¼š

- JSONB çš„è§£æžå’ŒæŸ¥è¯¢è¿‡ç¨‹æ˜¾è‘—æ›´å¿«ã€‚
- è®¿é—®ç‰¹å®šé”®è·¯å¾„ä¸éœ€è¦è¯»å–å®Œæ•´æ•°æ®ï¼Œè¿™å°†å¤§å¤§åŠ å¿«æ•´ä½“æ€§èƒ½ã€‚
- å¯ä»¥æ·»åŠ å¤–éƒ¨ç´¢å¼•ä»¥è¿›ä¸€æ­¥åŠ å¿«æŸ¥è¯¢é€Ÿåº¦ã€‚

#### äºŒè¿›åˆ¶ç¼–ç 

JSONB æ˜¯ä¸€ç§æ ‘ç»“æž„ã€‚æ¯ä¸ªèŠ‚ç‚¹ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼Œä¸€ä¸ª 32 ä½å¤´ï¼Œå‡ ä¸ª 32 ä½ `JEntry`ï¼Œä»¥åŠå¯å˜é•¿åº¦çš„åŽŸå§‹å†…å®¹ã€‚

- å¤´ä¹Ÿç§°ä¸ºå®¹å™¨å¤´ï¼Œå®ƒåŒ…æ‹¬ä¸€ä¸ª 3 ä½ç±»åž‹ï¼ˆåŒ…æ‹¬ `array`ã€`object` å’Œ `scalar`ï¼‰å’Œä¸€ä¸ª 28 ä½æŒ‡ç¤º `array` æˆ– `object` ä¸­çš„å…ƒç´ æ•°é‡ã€‚
- `JEntry` æœ‰ä¸€ä¸ª 3 ä½å€¼ç±»åž‹ï¼ˆåŒ…æ‹¬ `true`ã€`false`ã€`null`ã€`string`ã€`number`ã€`array` å’Œ `object`ï¼‰ï¼Œä¸€ä¸ª 28 ä½æä¾›åŽŸå§‹å†…å®¹çš„é•¿åº¦æˆ–åç§»é‡ï¼Œä»¥åŠä¸€ä¸ª 1 ä½æ ‡å¿—æŒ‡ç¤ºæ˜¯å¦ä½¿ç”¨é•¿åº¦æˆ–åç§»é‡ã€‚
- æœ€åŽä¸€éƒ¨åˆ†æ˜¯åŽŸå§‹å†…å®¹å€¼ï¼Œå¯ä»¥é€šè¿‡ `JEntry` ä¸­çš„é•¿åº¦æˆ–åç§»é‡å®šä½ã€‚

ä»¥è¿™ä¸ª JSON ä¸ºä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° JSONB çš„ç¼–ç æ ¼å¼å¦‚ä¸‹ã€‚

```json
{ "a": 1, "b": [true, 2, "v"] }
```

```
  .--------------.    .-----------------------------------.
  |    header    | -> |    type(object) | item nums(2)    |
  .--------------.    .-----------------------------------.
  | key1 JEntry  | -> | flag | val type(string) | len/off | -+
  .--------------.    .-----------------------------------.  |
  | key2 JEntry  | -> | flag | val type(string) | len/off | -+-+
  .--------------.    .-----------------------------------.  | |
  | val1 JEntry  | -> | flag | val type(number) | len/off | -+-+-+
  .--------------.    .-----------------------------------.  | | |
  | val2 JEntry  | -> | flag | val type(string) | len/off | -+-+-+-+
  .--------------.    .-----------------------------------.  | | | |
  |     "a"      | <-----------------------------------------+ | | |
  .--------------.                                             | | |
  |     "b"      | <-------------------------------------------+ | |
  .--------------.                                               | |
  |      1       | <---------------------------------------------+ |
  .--------------.                                                 |
  | [true,2,"v"] | <-----------------------------------------------+
  .--------------.
        |           .--------------+    .-----------------------------------.
        +---------> |    header    | -> |    type(array) | item nums(3)     |
                    .--------------+    .-----------------------------------.
                    | item1 JEntry | -> | flag | val type(bool true)        |
                    .--------------+    .-----------------------------------.
                    | item2 JEntry | -> | flag | val type(number) | len/off | -+
                    .--------------+    .-----------------------------------.  |
                    | item3 JEntry | -> | flag | val type(string) | len/off | -+-+
                    .--------------+    .-----------------------------------.  | |
                    |      2       | <-----------------------------------------+ |
                    .--------------.                                             |
                    |     "v"      | <-------------------------------------------+
                    .--------------.
```

æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜… [PostgreSQL](https://github.com/postgres/postgres/blob/master/src/include/utils/jsonb.h) å’Œ [CockroachDB](https://github.com/cockroachdb/cockroach/blob/master/docs/RFCS/20171005_jsonb_encoding.md) çš„è®¾è®¡

å¾—ç›ŠäºŽ JSONB çš„æ ‘ç»“æž„ï¼Œæœç´¢é”®è·¯å¾„åªéœ€è¦è§£æžéƒ¨åˆ†å®Œæ•´æ•°æ®ã€‚
åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸­ï¼Œå¯¹è±¡é”®å¯ä»¥åœ¨ O(ð‘™ð‘œð‘”(ð‘›)) æ—¶é—´å†…è®¿é—®ï¼Œå› ä¸ºé”®æ˜¯æŽ’åºçš„ï¼Œå¯ä»¥ä½¿ç”¨äºŒåˆ†æœç´¢ï¼Œè€Œæ•°ç»„å…ƒç´ å¯ä»¥åœ¨ O(1) æ—¶é—´å†…è®¿é—®ï¼Œå› ä¸º JEntry çš„é•¿åº¦æ˜¯å›ºå®šçš„ã€‚

## ç¼ºç‚¹

- æå–è™šæ‹Ÿåˆ—éœ€è¦é¢å¤–çš„å¼‚æ­¥ä»»åŠ¡ã€‚
- JSONB å¯èƒ½æ¯” JSON å ç”¨æ›´å¤šçš„ç£ç›˜ç©ºé—´ã€‚

## åŸºæœ¬åŽŸç†å’Œæ›¿ä»£æ–¹æ¡ˆ

[BSON](http://bsonspec.org) æ˜¯ MongoDB ä¸­ä½¿ç”¨çš„äºŒè¿›åˆ¶ JSON æ ¼å¼ã€‚
å…¶ä¸»è¦è®¾è®¡ç›®æ ‡æ˜¯å­˜å‚¨æ–‡æ¡£ï¼Œå› æ­¤åœ¨å¤´ä¸­æ²¡æœ‰é”®è·¯å¾„çš„ç´¢å¼•ã€‚

[ION](https://amzn.github.io/ion-docs/) ä¹Ÿæ˜¯ç”±äºšé©¬é€Šå¼€å‘çš„äºŒè¿›åˆ¶ JSON æ ¼å¼ã€‚
å®ƒé’ˆå¯¹è¯»å–è¿›è¡Œäº†ä¼˜åŒ–ï¼Œå¹¶ä½¿ç”¨ç¬¦å·è¡¨ä½œä¸ºç´¢å¼•æ¥åŠ å¿«é”®è·¯å¾„è®¿é—®ã€‚
å…¶ä¸»è¦é—®é¢˜æ˜¯ Rust ç‰ˆæœ¬çš„å¼€å‘ä»å¤„äºŽæ—©æœŸé˜¶æ®µï¼Œç¼ºå°‘ä¸€äº›é‡è¦çš„ trait æ”¯æŒï¼Œä¾‹å¦‚ `serde`ã€‚

è¿˜æœ‰ä¸€äº›é’ˆå¯¹çº¯æ–‡æœ¬ json çš„ä¼˜åŒ–ï¼Œä¾‹å¦‚
[simd-json](https://github.com/simd-lite/simd-json) ä½¿ç”¨ SIMD æŒ‡ä»¤æ¥åŠ é€Ÿè§£æžï¼Œ
[Pison](https://github.com/AutomataLab/Pison) é€šè¿‡æ·»åŠ ä½å›¾ç´¢å¼•æ¥åŠ é€Ÿè§£æžã€‚
ä½†å®ƒä»¬æ˜¯é’ˆå¯¹å®Œæ•´æ•°æ®çš„è§£æžè¿›è¡Œä¼˜åŒ–çš„ï¼Œå¯¹é€šè¿‡é”®è·¯å¾„è®¿é—®çš„åŠ é€Ÿæ²¡æœ‰å¸®åŠ©ã€‚

## å…ˆå‰æŠ€æœ¯

æœ¬ RFC çš„ä¸»è¦æ€æƒ³æ¥è‡ª [JSON Tiles](https://db.in.tum.de/people/sites/durner/papers/json-tiles-sigmod21.pdf) è®ºæ–‡ã€‚
è®ºæ–‡ä¸­çš„å®žéªŒè¯„ä¼°è¡¨æ˜Žï¼Œè¿™äº›ä¼˜åŒ–å¯ä»¥æœ‰æ•ˆæé«˜ JSON æ•°æ®çš„è¯»å–æ€§èƒ½ã€‚

PostgreSQL å’Œ CockroachDB éƒ½ä½¿ç”¨ JSONB ä½œä¸ºä¼˜åŒ–çš„ JSON æ ¼å¼ï¼Œæˆ‘ä»¬å¯ä»¥åŸºäºŽå®ƒä»¬çš„è®¾è®¡å®žçŽ° Rust ç‰ˆæœ¬çš„ JSONBã€‚

## æœªè§£å†³çš„é—®é¢˜

æ— ã€‚

## æœªæ¥çš„å¯èƒ½æ€§

- ä¸ºå€¼å…·æœ‰ä¸åŒæ•°æ®ç±»åž‹çš„é”®è·¯å¾„æå–è™šæ‹Ÿåˆ—
- ä¸º JSONB æ·»åŠ é¢å¤–ç´¢å¼•
