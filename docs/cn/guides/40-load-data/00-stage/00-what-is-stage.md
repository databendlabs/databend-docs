---
title: 什么是暂存区（Stage）？
---

在 Databend 中，暂存区是数据文件所在的虚拟位置。暂存区中的文件可以直接查询或加载到表中。您也可以将表中的数据卸载到暂存区作为文件。使用暂存区的优势在于，您可以像操作计算机文件夹一样便捷地进行数据加载和卸载。如同将文件放入文件夹时无需知晓其在硬盘上的精确位置，访问暂存区文件时只需指定暂存区名称和文件名（如 `@mystage/mydatafile.csv`），无需关注其在对象存储桶中的具体路径。与计算机文件夹类似，您可以在 Databend 中创建任意数量的暂存区。但需注意：暂存区不可嵌套，每个暂存区独立运行且不包含其他暂存区。

使用暂存区加载数据还能提升文件上传、管理和过滤的效率。通过 [BendSQL](../../30-sql-clients/00-bendsql/index.md)，您只需单条命令即可轻松上传或下载暂存区文件。向 Databend 加载数据时，您可在 COPY INTO 命令中直接指定暂存区，该命令将自动读取并过滤该暂存区的数据文件。同样，从 Databend 导出数据时，您可将数据文件转储至暂存区。

## 暂存区类型

根据存储位置和访问权限，暂存区可分为三种类型：内部暂存区、外部暂存区和用户暂存区。下表总结了 Databend 中各类暂存区的特性，包括存储位置、访问权限及适用场景：

|                      | 用户暂存区                         | 内部暂存区                                   | 外部暂存区                                                                                                |
|----------------------|------------------------------------|--------------------------------------------------|---------------------------------------------------------------------------------------------------------------|
| **存储位置** | 内部对象存储（Databend） | 内部对象存储（Databend）               | 外部对象存储（如 S3、Azure）                                                                     |
| **创建方式**  | 自动创建              | 手动创建：`CREATE STAGE stage_name;` | 手动创建：`CREATE STAGE stage_name` `'s3://bucket/prefix/'` `CONNECTION=(endpoint_url='x', ...);` |
| **访问控制**   | 仅创建用户可访问        | 可共享给其他用户或角色          | 可共享给其他用户或角色                                                                       |
| **删除操作**       | 禁止                        | 删除暂存区并清除其中文件         | 仅删除暂存区定义，外部文件保留                                           |
| **文件上传**      | 需上传至 Databend      | 需上传至 Databend                    | 无需上传，直接读取或卸载外部存储数据                                        |
| **适用场景**   | 个人/私有数据              | 团队/共享数据                                 | 外部数据集成或卸载                                                                        |
| **路径格式**      | `@~/`                              | `@stage_name/`                                   | `@stage_name/`                                                                                                |

### 内部暂存区

内部暂存区的文件实际存储在 Databend 对象存储中。该类型可供组织内所有用户访问，每个用户均可用于数据加载或导出任务。创建时需指定名称，如同创建文件夹。以下是通过 [CREATE STAGE](/sql/sql-commands/ddl/stage/ddl-create-stage) 命令创建内部暂存区的示例：

```sql
-- 创建名为 my_internal_stage 的内部暂存区
CREATE STAGE my_internal_stage;
```

### 外部暂存区

外部暂存区指向 Databend 外部的对象存储位置。例如，若您的数据集位于 Google Cloud Storage 容器中，可基于该容器创建外部暂存区。创建时必须提供外部存储的连接信息。

假设您的数据集存储在 Amazon S3 存储桶 `databend-doc` 中：

![alt text](/img/guides/external-stage.png)

通过 [CREATE STAGE](/sql/sql-commands/ddl/stage/ddl-create-stage) 命令创建外部暂存区连接该存储桶：

```sql
-- 创建名为 my_external_stage 的外部暂存区
CREATE STAGE my_external_stage
    URL = 's3://databend-doc'
    CONNECTION = (
        AWS_KEY_ID = '<YOUR-KEY-ID>',
        AWS_SECRET_KEY = '<YOUR-SECRET-KEY>'
    );
```

创建后即可从 Databend 访问数据集。例如列出文件：

```sql
LIST @my_external_stage;

┌────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│      name     │  size  │                 md5                │         last_modified         │      creator     │
├───────────────┼────────┼────────────────────────────────────┼───────────────────────────────┼──────────────────┤
│ Inventory.csv │  57585 │ "0cd02fb636a22ba9f4ae4d24555a7d68" │ 2024-03-17 21:22:38.000 +0000 │ NULL             │
│ Products.csv  │  42987 │ "570e5cbf6a4b6e7e9a258094192f4784" │ 2024-03-17 21:22:38.000 +0000 │ NULL             │
└────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

> **注意**  
> 外部存储必须是 Databend 支持的对象存储方案。[CREATE STAGE](/sql/sql-commands/ddl/stage/ddl-create-stage) 命令文档提供了常用对象存储的连接配置示例。

### 用户暂存区

用户暂存区是内部暂存区的特殊类型：文件存储在 Databend 对象存储中，但其他用户不可访问。每个用户自动拥有专属用户暂存区，无需创建或命名，且不可删除。

该类型适用于存储无需共享的个人数据文件。通过 `@~` 访问用户暂存区，例如列出所有文件：

```sql
LIST @~;
```

## 管理暂存区

Databend 提供以下命令管理暂存区及其文件：

| 命令                                                      | 描述                                                                                                                                                                                                                          | 用户暂存区 | 内部暂存区 | 外部暂存区 |
| ------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | --------------------- | ------------------------- | ------------------------- |
| [CREATE STAGE](/sql/sql-commands/ddl/stage/ddl-create-stage) | 创建内部/外部暂存区                                                                                                                                                                                               | 否                    | 是                       | 是                       |
| [DROP STAGE](/sql/sql-commands/ddl/stage/ddl-drop-stage)     | 删除内部/外部暂存区                                                                                                                                                                                               | 否                    | 是                       | 是                       |
| [DESC STAGE](/sql/sql-commands/ddl/stage/ddl-desc-stage)     | 显示暂存区属性                                                                                                                                                                                               | 否                    | 是                       | 是                       |
| [LIST](/sql/sql-commands/ddl/stage/ddl-list-stage)           | 列出暂存区文件<br>或使用表函数 [LIST_STAGE](/sql/sql-functions/table-functions/list-stage) 灵活获取文件详情 | 是                   | 是                       | 是                       |
| [REMOVE](/sql/sql-commands/ddl/stage/ddl-remove-stage)       | 删除暂存区文件                                                                                                                                                                                                   | 是                   | 是                       | 是                       |
| [SHOW STAGES](/sql/sql-commands/ddl/stage/ddl-show-stages)   | 列出所有已创建的暂存区                                                                                                                                                                          | 否                    | 是                       | 是                       |