---
title: 阶段文件上传
---
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

Databend 推荐使用两种文件上传方法：[PRESIGN](/sql/sql-commands/ddl/stage/presign) 和 PUT/GET 命令。这些方法允许客户端与存储之间直接进行数据传输，省去了中间环节，通过减少 Databend 与您的存储之间的流量来节省成本。

![Alt text](@site/docs/public/img/load/staging-file.png)

PRESIGN 方法生成一个有时间限制的带签名的 URL，客户端可以使用这个 URL 安全地启动文件上传。这个 URL 临时授权访问指定的阶段，允许客户端直接传输数据，而不依赖于 Databend 服务器完成整个过程，从而提高了安全性和效率。

如果您使用 [BendSQL](../../30-sql-clients/00-bendsql/index.md) 来管理阶段中的文件，您可以使用 PUT 命令上传文件和 GET 命令下载文件。

- GET 命令目前只能下载阶段中的所有文件，不能下载单个文件。
- 这些命令仅限于 BendSQL 使用，当 Databend 使用文件系统作为存储后端时，GET 命令将不起作用。

## 示例

### 使用预签名 URL 上传

以下示例演示了如何使用预签名 URL 将样本文件（[books.parquet](https://datafuse-1253727613.cos.ap-hongkong.myqcloud.com/data/books.parquet)）上传到用户阶段、内部阶段和外部阶段。

<Tabs groupId="presign">

<TabItem value="user" label="上传到用户阶段">

```sql
PRESIGN UPLOAD @~/books.parquet;
```

结果:
```
┌────────┬────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│ 名称   │ 值                                                                                                                │
├────────┼────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ 方法   │ PUT                                                                                                                │
│ 头信息 │ {"host":"s3.us-east-2.amazonaws.com"}                                                                              │
│ url    │ https://s3.us-east-2.amazonaws.com/databend-toronto/stage/user/root/books.parquet?X-Amz-Algorithm...               │
└────────┴────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```
```shell
curl -X PUT -T books.parquet "https://s3.us-east-2.amazonaws.com/databend-toronto/stage/user/root/books.parquet?X-Amz-Algorithm=... ...
```

检查阶段文件：

```sql
LIST @~;
```

结果:
```
┌───────────────┬──────┬──────────────────────────────────────┬─────────────────────────────────┬─────────┐
│ 名称          │ 大小 │ md5                                  │ 最后修改时间                      │ 创建者  │
├───────────────┼──────┼──────────────────────────────────────┼─────────────────────────────────┼─────────┤
│ books.parquet │  998 │ 88432bf90aadb79073682988b39d461c     │ 2023-06-27 16:03:51.000 +0000   │         │
└───────────────┴──────┴──────────────────────────────────────┴─────────────────────────────────┴─────────┘
```
</TabItem>

<TabItem value="internal" label="上传到内部阶段">

```sql
CREATE STAGE my_internal_stage;
```
```sql
PRESIGN UPLOAD @my_internal_stage/books.parquet;
```



结果：
```
┌─────────┬─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│ 名称    │ 值                                                                                                                                                                                                                                                                                                                                                                                                                               │
├─────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ 方法    │ PUT                                                                                                                                                                                                                                                                                                                                                                                                                                 │
│ 头部    │ {"host":"s3.us-east-2.amazonaws.com"}                                                                                                                                                                                                                                                                                                                                                                                               │
│ 网址    │ https://s3.us-east-2.amazonaws.com/databend-toronto/stage/internal/my_internal_stage/books.parquet?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIASTQNLUZWP2UY2HSN%2F20230628%2Fus-east-2%2Fs3%2Faws4_request&X-Amz-Date=20230628T022951Z&X-Amz-Expires=3600&X-Amz-SignedHeaders=host&X-Amz-Signature=9cfcdf3b3554280211f88629d60358c6d6e6a5e49cd83146f1daea7dfe37f5c1 │
└─────────┴─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

```shell
curl -X PUT -T books.parquet "https://s3.us-east-2.amazonaws.com/databend-toronto/stage/internal/my_internal_stage/books.parquet?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIASTQNLUZWP2UY2HSN%2F20230628%2Fus-east-2%2Fs3%2Faws4_request&X-Amz-Date=20230628T022951Z&X-Amz-Expires=3600&X-Amz-SignedHeaders=host&X-Amz-Signature=9cfcdf3b3554280211f88629d60358c6d6e6a5e49cd83146f1daea7dfe37f5c1"
```

检查已暂存的文件：

```sql
LIST @my_internal_stage;
```

```markdown
结果：
```
┌──────────────────────────────────┬───────┬──────────────────────────────────────┬─────────────────────────────────┬─────────┐
│ 名称                               │ 大小    │ md5                                   │ 最后修改时间                         │ 创建者    │
├──────────────────────────────────┼───────┼──────────────────────────────────────┼─────────────────────────────────┼─────────┤
│ books.parquet                    │   998 │ "88432bf90aadb79073682988b39d461c"     │ 2023-06-28 02:32:15.000 +0000  │         │
└──────────────────────────────────┴───────┴──────────────────────────────────────┴─────────────────────────────────┴─────────┘
```
</TabItem>
<TabItem value="external" label="上传到外部阶段">

```sql
CREATE STAGE my_external_stage 
URL = 's3://databend' 
CONNECTION = (
    ENDPOINT_URL = 'http://127.0.0.1:9000',
    aws_key_id = 'ROOTUSER',
    aws_secret_key = 'CHANGEME123'
);
```

```sql
PRESIGN UPLOAD @my_external_stage/books.parquet;
```
结果：
```
┌─────────┬─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│ 名称      │ 值                                                                                                                                                                                                                                                                                                                               │
├─────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ 方法      │ PUT                                                                                                                                                                                                                                                                                                                               │
│ 头部      │ {"host":"127.0.0.1:9000"}                                                                                                                                                                                                                                                                                                         │
│ url     │ http://127.0.0.1:9000/databend/books.parquet?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ROOTUSER%2F20230628%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20230628T040959Z&X-Amz-Expires=3600&X-Amz-SignedHeaders=host&X-Amz-Signature=<signature...>                                                │
└─────────┴─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```shell
curl -X PUT -T books.parquet "http://127.0.0.1:9000/databend/books.parquet?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ROOTUSER%2F20230628%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20230628T040959Z&X-Amz-Expires=3600&X-Amz-SignedHeaders=host&X-Amz-Signature=<signature...>"
```

检查已暂存的文件：

```sql
LIST @my_external_stage;
```

```

Result:
```
┌────────────────────────────────────────────────────────────────────────┐
│      name     │  size  │ ··· │     last_modified    │      creator     │
├───────────────┼────────┼─────┼──────────────────────┼──────────────────┤
│ books.parquet │    998 │ ... │ 2023-09-04 03:32:... │ NULL             │
└────────────────────────────────────────────────────────────────────────┘
```

```sql
GET @my_internal_stage/ fs:///Users/eric/Downloads/fromStage/;
```

Result:
```
┌─────────────────────────────────────────────────────────┐
│                      file                     │  status │
├───────────────────────────────────────────────┼─────────┤
│ /Users/eric/Downloads/fromStage/books.parquet │ SUCCESS │
└─────────────────────────────────────────────────────────┘
```
</TabItem>

<TabItem value="external" label="Download from External Stage">

```sql
LIST @my_external_stage;
```

Result:
```
┌──────────────────────────────────────────────────────────────────────┐
│         name         │ ··· │     last_modified    │      creator     │
├──────────────────────┼─────┼──────────────────────┼──────────────────┤
│ books.parquet        │ ... │ 2023-09-04 03:37:... │ NULL             │
└──────────────────────────────────────────────────────────────────────┘
```

```sql
GET @my_external_stage/ fs:///Users/eric/Downloads/fromStage/;
```

Result:
```
┌─────────────────────────────────────────────────────────┐
│                      file                     │  status │
├───────────────────────────────────────────────┼─────────┤
│ /Users/eric/Downloads/fromStage/books.parquet │ SUCCESS │
└─────────────────────────────────────────────────────────┘
```
</TabItem>
</Tabs>

### 注意事项

- 使用 `PUT` 和 `GET` 命令时，确保你有足够的权限来访问指定的文件路径。
- 在执行 `PUT` 命令上传文件到舞台（Stage）时，文件将被上传到指定的位置。
- 在执行 `GET` 命令下载文件时，文件将被下载到本地指定的路径。
- 使用 `LIST` 命令可以查看舞台（Stage）上的文件列表。

<Tabs groupId="notes">

<TabItem value="put" label="PUT 命令注意事项">

- 确保文件路径正确无误。
- 如果上传到用户舞台，使用 `@~` 作为目标路径。
- 如果上传到内部舞台，确保已经创建了该舞台，并使用 `@<stage_name>` 作为目标路径。
- 如果上传到外部舞台，确保已经创建了该舞台并配置了正确的连接信息，然后使用 `@<stage_name>` 作为目标路径。

</TabItem>

<TabItem value="get" label="GET 命令注意事项">

- 确保本地目标路径正确无误，并且有足够的权限写入文件。
- 使用 `@<stage_name>/` 来指定从哪个舞台下载文件。
- 如果从用户舞台下载，使用 `@~/` 作为源路径。

</TabItem>
</Tabs>

```markdown
<TabItem value="internal" label="从内部阶段下载">

结果：
```
┌────────────────────────────────────────────────────────────────────────┐
│      name     │  size  │ ··· │     last_modified    │      creator     │
├───────────────┼────────┼─────┼──────────────────────┼──────────────────┤
│ books.parquet │    998 │ ... │ 2023-09-04 03:32:... │ NULL             │
└────────────────────────────────────────────────────────────────────────┘
```

```sql
GET @my_internal_stage/ fs:///Users/eric/Downloads/fromStage/;
```

结果：
```
┌─────────────────────────────────────────────────────────┐
│                      file                     │  status │
├───────────────────────────────────────────────┼─────────┤
│ /Users/eric/Downloads/fromStage/books.parquet │ SUCCESS │
└─────────────────────────────────────────────────────────┘
```
</TabItem>
<TabItem value="external" label="从外部阶段下载">

```sql
LIST @my_external_stage;
```

结果：
```
┌──────────────────────────────────────────────────────────────────────┐
│         name         │ ··· │     last_modified    │      creator     │
├──────────────────────┼─────┼──────────────────────┼──────────────────┤
│ books.parquet        │ ... │ 2023-09-04 03:37:... │ NULL             │
└──────────────────────────────────────────────────────────────────────┘
```

```sql
GET @my_external_stage/ fs:///Users/eric/Downloads/fromStage/;
```

结果：
```
┌─────────────────────────────────────────────────────────┐
│                      file                     │  status │
├───────────────────────────────────────────────┼─────────┤
│ /Users/eric/Downloads/fromStage/books.parquet │ SUCCESS │
└─────────────────────────────────────────────────────────┘
```
</TabItem>
</Tabs>
```