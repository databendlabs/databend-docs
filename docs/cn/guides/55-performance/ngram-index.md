---
title: Ngram 索引
---

# Ngram 索引：LIKE 查询的快速模式匹配

import EEFeature from '@site/src/components/EEFeature';

<EEFeature featureName='NGRAM INDEX'/>

Ngram 索引通过带通配符 (`%`) 的 `LIKE` 运算符加速模式匹配查询，实现无需全表扫描的快速子字符串搜索。

## 解决什么问题？

`LIKE` 查询在大型数据集上进行模式匹配时面临显著性能挑战：

| 问题 | 影响 | Ngram 索引解决方案 |
|---------|--------|---------------------|
| **通配符搜索缓慢** | `WHERE content LIKE '%keyword%'` 需扫描全表 | 使用 n-gram 分段预过滤数据块 |
| **全表扫描** | 每次模式搜索需读取所有行 | 仅读取包含模式的相关数据块 |
| **搜索性能差** | 用户需长时间等待子字符串搜索结果 | 亚秒级模式匹配响应速度 |
| **传统索引失效** | B-tree 索引无法优化中间通配符 | 字符级索引处理任意通配符位置 |

**示例**：在 1000 万条日志中搜索 `'%error log%'`。无 ngram 索引时需扫描全部数据；启用后瞬间预过滤至约 1000 个相关块。

## Ngram 与全文索引：如何选择？

| 功能 | Ngram 索引 | 全文索引 |
|---------|-------------|-----------------|
| **主要用例** | `LIKE '%pattern%'` 模式匹配 | `MATCH()` 语义文本搜索 |
| **搜索类型** | 精确子字符串匹配 | 基于词汇的相关性搜索 |
| **查询语法** | `WHERE column LIKE '%text%'` | `WHERE MATCH(column, 'text')` |
| **高级功能** | 不区分大小写匹配 | 模糊搜索、相关性评分、布尔运算符 |
| **性能重点** | 加速现有 LIKE 查询 | 用高级搜索替代 LIKE |
| **最佳场景** | 日志分析、代码搜索、精确匹配 | 文档搜索、内容发现、搜索引擎 |

**选择 Ngram 索引：**
- 需优化现有 `LIKE '%pattern%'` 查询
- 要求精确子字符串匹配（不区分大小写）
- 处理日志、代码或 ID 等结构化数据
- 期望不修改查询语法提升性能

**选择全文索引：**
- 构建文档/内容搜索功能
- 需要模糊搜索、相关性评分或复杂查询
- 处理自然语言文本
- 需超越简单模式匹配的高级搜索能力

## 工作原理

Ngram 索引将文本拆解为重叠字符子串（n-grams）实现快速模式查找：

**`gram_size = 3` 示例：**
```text
输入："The quick brown"
N-grams："The", "he ", "e q", " qu", "qui", "uic", "ick", "ck ", "k b", " br", "bro", "row", "own"
```

**查询处理流程：**
```sql
SELECT * FROM t WHERE content LIKE '%quick br%'
```
1. 模式 `'quick br'` 被拆解为 n-grams："qui", "uic", "ick", "ck ", "k b", " br"
2. 索引过滤包含这些 n-grams 的数据块
3. 完整 `LIKE` 过滤仅作用于预筛选块

:::note **重要限制**
- 模式长度需 ≥ `gram_size`（如 `gram_size=3` 时 `'%yo%'` 无法使用索引）
- 匹配不区分大小写（"FOO" 可匹配 "foo"、"Foo"、"fOo"）
- 仅支持 `LIKE` 运算符，不适用其他模式匹配函数
:::

## 快速配置

```sql
-- 创建含文本字段的表
CREATE 